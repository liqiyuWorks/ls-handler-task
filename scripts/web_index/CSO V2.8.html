<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CSO :: AI å¢å¼ºç‰ˆåœºæ™¯å·¥ä½œå°</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Marked for Markdown parsing -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <!-- Mermaid.js for Mindmaps -->
    <script src="https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@300;400;500;700&display=swap');
        
        body { font-family: 'Noto Sans SC', sans-serif; background-color: #f8fafc; }
        
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }

        .typing-indicator span {
            animation: blink 1.4s infinite both;
            height: 5px; width: 5px; background: #94a3b8; border-radius: 50%; display: inline-block; margin: 0 1px;
        }
        .typing-indicator span:nth-child(2) { animation-delay: 0.2s; }
        .typing-indicator span:nth-child(3) { animation-delay: 0.4s; }
        @keyframes blink { 0% { opacity: 0.2; } 20% { opacity: 1; } 100% { opacity: 0.2; } }

        .chat-bubble { max-width: 85%; transition: all 0.2s; border: 2px solid transparent; }
        .chat-bubble.ai { background: #f1f5f9; color: #334155; border-radius: 12px 12px 12px 2px; }
        .chat-bubble.user { background: #2563eb; color: white; border-radius: 12px 12px 2px 12px; margin-left: auto; }
        
        /* Selection Mode Styles */
        .selection-mode .chat-bubble { cursor: pointer; opacity: 0.7; }
        .selection-mode .chat-bubble:hover { opacity: 1; transform: scale(1.01); }
        .chat-bubble.selected { border-color: #3b82f6; box-shadow: 0 0 15px rgba(59, 130, 246, 0.2); opacity: 1 !important; transform: scale(1.01); }
        .chat-bubble.selected.ai { background-color: #e0f2fe; border-color: #3b82f6; }
        .chat-bubble.selected.user { border-color: #93c5fd; }
        
        /* Markdown Styles in Chat */
        .prose p { margin-bottom: 0.5em; }
        .prose ul { list-style-type: disc; padding-left: 1.2em; margin-bottom: 0.5em; }
        .prose strong { font-weight: 600; }
        
        /* Sidebar Transition */
        #sidebar { transition: margin-left 0.3s ease-in-out; }
        .sidebar-hidden { margin-left: -16rem; } 
        
        /* Step Divider in Chat */
        .chat-divider {
            display: flex; align-items: center; justify-content: center;
            margin: 1.5rem 0; color: #94a3b8; font-size: 0.75rem; font-weight: 500;
        }
        .chat-divider::before, .chat-divider::after {
            content: ''; flex: 1; border-bottom: 1px solid #e2e8f0; margin: 0 10px;
        }

        @media print {
            .no-print { display: none !important; }
            .print-only { display: block !important; }
            #editor-view { display: none; }
            #report-view { display: block !important; }
            #sidebar { display: none; }
            body { background-color: white; }
        }

        .tooltip-trigger:hover .tooltip-content { display: block; }
        
        /* Dropdown Animation */
        .dropdown-menu {
            transform-origin: top right;
            transition: transform 0.1s ease-out, opacity 0.1s ease-out;
        }
        .dropdown-hidden { transform: scale(0.95); opacity: 0; pointer-events: none; }
        .dropdown-visible { transform: scale(1); opacity: 1; pointer-events: auto; }
    </style>
</head>
<body class="h-screen flex overflow-hidden text-slate-800">

    <!-- Mindmap Modal -->
    <div id="mindmap-modal" class="fixed inset-0 bg-black/80 z-[60] hidden flex items-center justify-center backdrop-blur-sm">
        <div class="bg-white rounded-xl shadow-2xl w-[90vw] h-[90vh] flex flex-col overflow-hidden relative">
            <div class="p-4 border-b border-gray-200 flex justify-between items-center bg-gray-50">
                <h3 class="font-bold text-gray-700 flex items-center gap-2">
                    <i class="fas fa-brain text-purple-500"></i> AI æ€ç»´å¯¼å›¾
                </h3>
                <button onclick="document.getElementById('mindmap-modal').classList.add('hidden')" class="text-gray-400 hover:text-gray-700 w-8 h-8 rounded-full hover:bg-gray-200 flex items-center justify-center transition-all">
                    <i class="fas fa-times text-lg"></i>
                </button>
            </div>
            <div class="flex-1 overflow-auto bg-white p-4 flex items-center justify-center" id="mindmap-container">
                <div class="text-gray-400">æ­£åœ¨ç”Ÿæˆ...</div>
            </div>
        </div>
    </div>

    <!-- Settings Modal -->
    <div id="settings-modal" class="fixed inset-0 bg-black/50 z-50 hidden flex items-center justify-center backdrop-blur-sm">
        <div class="bg-white rounded-xl shadow-2xl w-[38rem] p-6 transform transition-all scale-100 max-h-[95vh] overflow-y-auto">
            <h2 class="text-xl font-bold mb-6 flex items-center gap-2 border-b pb-2">
                <i class="fas fa-sliders-h text-slate-400"></i> å·¥ä½œå°é…ç½®
            </h2>
            <div class="space-y-6">
                <!-- Mode Selection -->
                <div>
                    <label class="block text-sm font-bold text-slate-700 mb-3">é€‰æ‹© AI åŠ©æ‰‹æ¨¡å¼</label>
                    <div class="grid grid-cols-2 gap-4">
                        <label class="cursor-pointer border-2 rounded-lg p-3 flex flex-col items-center hover:bg-blue-50 transition-colors" id="opt-api-label">
                            <input type="radio" name="ai_mode" value="api" class="mb-2" onchange="app.toggleSettingsUI()">
                            <i class="fas fa-bolt text-blue-500 text-xl mb-1"></i>
                            <span class="font-bold text-sm">API ç›´è¿æ¨¡å¼</span>
                            <span class="text-xs text-slate-400 text-center mt-1">æ”¯æŒ Gemini/DeepSeek/GPT<br>å¯¹è¯è¿ç»­ï¼Œè‡ªåŠ¨è®°å¿†</span>
                        </label>
                        <label class="cursor-pointer border-2 rounded-lg p-3 flex flex-col items-center hover:bg-blue-50 transition-colors" id="opt-web-label">
                            <input type="radio" name="ai_mode" value="web" class="mb-2" onchange="app.toggleSettingsUI()">
                            <i class="fas fa-globe text-green-500 text-xl mb-1"></i>
                            <span class="font-bold text-sm">ç½‘é¡µåµŒå…¥æ¨¡å¼</span>
                            <span class="text-xs text-slate-400 text-center mt-1">ç›´æ¥åµŒå…¥ç½‘é¡µç‰ˆèŠå¤©çª—å£<br>æ— éœ€ API Key</span>
                        </label>
                    </div>
                </div>

                <!-- API Config Section -->
                <div id="config-api" class="space-y-4 p-5 bg-slate-50 rounded-lg border border-slate-100">
                    <div>
                        <label class="block text-xs font-bold text-slate-500 uppercase mb-1">æ¨¡å‹æä¾›å•† (Provider)</label>
                        <select id="api-provider" class="w-full border border-slate-300 rounded-lg px-3 py-2 text-sm bg-white focus:ring-2 focus:ring-blue-500 outline-none" onchange="app.handleProviderChange()">
                            <option value="gemini">Google Gemini (å®˜æ–¹)</option>
                            <option value="openai">OpenAI (ChatGPT)</option>
                            <option value="deepseek">DeepSeek (æ·±åº¦æ±‚ç´¢)</option>
                            <option value="grok">Grok (xAI)</option>
                            <option value="qwen">Qwen (é˜¿é‡Œé€šä¹‰åƒé—®)</option>
                            <option value="custom">è‡ªå®šä¹‰ (Custom OpenAI Format)</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-slate-500 uppercase mb-1">API Key</label>
                        <input type="password" id="api-key-input" class="w-full border border-slate-300 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-blue-500 outline-none bg-white font-mono" placeholder="sk-...">
                    </div>
                    <div class="grid grid-cols-1 gap-4">
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Base URL</label>
                                <input type="text" id="api-base-url" class="w-full border border-slate-300 rounded-lg px-3 py-2 text-xs focus:ring-2 focus:ring-blue-500 outline-none bg-white text-slate-600 font-mono">
                            </div>
                            <div>
                                <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Model Name</label>
                                <input type="text" id="api-model-name" class="w-full border border-slate-300 rounded-lg px-3 py-2 text-xs focus:ring-2 focus:ring-blue-500 outline-none bg-white text-slate-600 font-mono" placeholder="è¾“å…¥æ¨¡å‹åç§°">
                            </div>
                        </div>
                        <div>
                             <label class="block text-xs font-bold text-slate-500 uppercase mb-1 text-blue-600">å¿«é€Ÿé€‰æ‹©æ¨èæ¨¡å‹ (Quick Select)</label>
                             <select id="model-quick-select" class="w-full border border-blue-200 bg-blue-50 rounded-lg px-3 py-2 text-xs text-slate-700 outline-none cursor-pointer hover:bg-blue-100 transition-colors" onchange="app.applyQuickModel()"></select>
                        </div>
                    </div>
                </div>

                <!-- Web Config Section -->
                <div id="config-web" class="space-y-3 p-4 bg-slate-50 rounded-lg border border-slate-100 hidden">
                    <label class="block text-xs font-bold text-slate-500 uppercase">ç›®æ ‡ç½‘é¡µ URL</label>
                    <input type="text" id="web-url-input" class="w-full border border-slate-300 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-green-500 outline-none bg-white" placeholder="ä¾‹å¦‚: https://chatgpt.com/">
                    <div class="text-xs text-amber-600 bg-amber-50 p-2 rounded border border-amber-100 flex gap-2">
                        <i class="fas fa-exclamation-triangle mt-0.5"></i>
                        <p>æ³¨æ„ï¼šç½‘é¡µæ¨¡å¼ä¸‹ï¼Œå¯¹è¯å†å²å­˜å‚¨åœ¨ç¬¬ä¸‰æ–¹ç½‘é¡µä¸­ï¼Œæœ¬å·¥å…·æ— æ³•ç›´æ¥è¯»å–ã€‚</p>
                    </div>
                </div>
            </div>

            <div class="mt-8 flex justify-end gap-2 border-t pt-4">
                <button onclick="document.getElementById('settings-modal').classList.add('hidden')" class="px-4 py-2 text-sm text-slate-600 hover:bg-slate-100 rounded-lg">å–æ¶ˆ</button>
                <button onclick="app.saveSettings()" class="px-6 py-2 text-sm bg-blue-600 text-white rounded-lg hover:bg-blue-700 font-medium">ä¿å­˜ç”Ÿæ•ˆ</button>
            </div>
        </div>
    </div>

    <!-- Sidebar -->
    <aside id="sidebar" class="w-64 bg-slate-900 text-slate-300 flex flex-col shadow-xl z-20 flex-shrink-0 no-print">
        <div class="p-5 border-b border-slate-800 flex items-center justify-between">
            <div class="font-bold text-white tracking-wider flex items-center gap-2">
                <span class="w-8 h-8 bg-blue-600 rounded flex items-center justify-center text-sm">AI</span>
                CSO 2.8
            </div>
            <button onclick="app.toggleSidebar()" class="text-slate-500 hover:text-white transition-colors" title="æ”¶èµ·å¯¼èˆªæ ">
                <i class="fas fa-angle-left text-lg"></i>
            </button>
        </div>
        <nav class="flex-1 overflow-y-auto py-4 px-2 space-y-6">
            <div id="nav-container"></div>
        </nav>
        <div class="p-4 border-t border-slate-800">
             <button onclick="app.showReport()" class="w-full bg-slate-800 hover:bg-blue-900 text-white py-2 rounded-lg text-sm transition-colors flex items-center justify-center gap-2">
                <i class="fas fa-file-alt"></i> ç”ŸæˆæŠ¥å‘Š
            </button>
        </div>
    </aside>

    <!-- Main Content -->
    <main class="flex-1 flex flex-col h-screen overflow-hidden bg-slate-50 relative">
        <!-- Header -->
        <header class="h-14 bg-white border-b border-slate-200 flex items-center justify-between px-4 flex-shrink-0 no-print shadow-sm z-10">
            <div class="flex items-center gap-4 text-sm">
                <button onclick="app.toggleSidebar()" class="text-slate-500 hover:text-blue-600 w-8 h-8 flex items-center justify-center rounded hover:bg-slate-100 transition-colors" title="æŠ˜å /å±•å¼€å·¦ä¾§å¯¼èˆª">
                    <i class="fas fa-bars text-lg"></i>
                </button>
                <button onclick="app.toggleNotes()" class="text-slate-500 hover:text-blue-600 w-8 h-8 flex items-center justify-center rounded hover:bg-slate-100 transition-colors" title="æŠ˜å /å±•å¼€ç¬”è®°é¢æ¿">
                    <i class="fas fa-book-open text-lg" id="notes-toggle-icon"></i>
                </button>
                <div class="w-px h-4 bg-slate-200"></div>
                <div class="flex items-center gap-2">
                    <span id="header-phase" class="font-bold text-blue-600 hidden sm:inline">Phase 1</span>
                    <span class="text-slate-300 hidden sm:inline">/</span>
                    <span id="header-step" class="text-slate-700 font-medium text-lg sm:text-sm">å‘ç°é—®é¢˜</span>
                </div>
            </div>
            <div class="flex items-center gap-4">
                <button onclick="app.openSettings()" class="text-xs bg-slate-100 hover:bg-slate-200 text-slate-600 px-3 py-1.5 rounded-full transition-colors flex items-center gap-2 border border-slate-200">
                    <i class="fas fa-robot" id="mode-icon"></i>
                    <span id="mode-text">é…ç½® API</span>
                    <i class="fas fa-cog ml-1 text-slate-400"></i>
                </button>
                <div class="w-px h-4 bg-slate-200"></div>
                <input type="text" id="project-name-header" placeholder="æœªå‘½åé¡¹ç›®..." class="text-right text-sm border-none bg-transparent focus:ring-0 text-slate-600 placeholder-slate-400 w-32 sm:w-48" onchange="app.saveData()">
                <div class="text-xs text-slate-400">
                    <i class="fas fa-check-circle" id="save-icon"></i>
                </div>
            </div>
        </header>

        <!-- Editor View (Split Screen) -->
        <div id="editor-view" class="flex-1 flex overflow-hidden relative">
            <!-- Left: Workspace -->
            <div class="w-1/2 flex flex-col border-r border-slate-200 bg-white transition-all duration-300" id="left-panel">
                <div class="p-3 border-b border-slate-100 bg-slate-50 flex justify-between items-center flex-shrink-0 relative">
                    <label class="text-xs font-bold text-slate-500 uppercase tracking-wider flex items-center gap-2">
                        <i class="fas fa-pen-fancy"></i> ä½ çš„ç»“è®º
                    </label>
                    <div class="flex items-center gap-2">
                        <button onclick="app.copyCurrentStep()" class="text-slate-400 hover:text-blue-600 w-7 h-7 flex items-center justify-center rounded transition-colors" title="å¤åˆ¶å½“å‰ç»“è®º">
                            <i class="fas fa-copy"></i>
                        </button>
                        <div class="relative">
                            <button onclick="app.toggleExportMenu()" class="text-slate-400 hover:text-purple-600 w-7 h-7 flex items-center justify-center rounded transition-colors" title="è¾“å‡º/ç”Ÿæˆ">
                                <i class="fas fa-share-square"></i>
                            </button>
                            <div id="export-menu" class="dropdown-menu dropdown-hidden absolute right-0 top-8 w-48 bg-white rounded-lg shadow-xl border border-gray-100 z-50 overflow-hidden">
                                <button onclick="app.exportMarkdown()" class="w-full text-left px-4 py-3 text-sm text-gray-700 hover:bg-gray-50 flex items-center gap-2">
                                    <i class="fas fa-file-code text-slate-400 w-5"></i> å¯¼å‡º Markdown
                                </button>
                                <button onclick="app.generateMindMap()" class="w-full text-left px-4 py-3 text-sm text-gray-700 hover:bg-gray-50 flex items-center gap-2 border-t border-gray-50">
                                    <i class="fas fa-brain text-purple-400 w-5"></i> ç”Ÿæˆæ€ç»´å¯¼å›¾ (AI)
                                </button>
                                <button onclick="window.print()" class="w-full text-left px-4 py-3 text-sm text-gray-700 hover:bg-gray-50 flex items-center gap-2 border-t border-gray-50">
                                    <i class="fas fa-file-pdf text-red-400 w-5"></i> å¯¼å‡º PDF æŠ¥å‘Š
                                </button>
                            </div>
                        </div>
                        <div class="w-px h-4 bg-gray-300 mx-1"></div>
                        <div class="tooltip-trigger relative">
                            <button onclick="app.handleExtract()" id="extract-btn" class="text-xs bg-blue-100 text-blue-700 px-2 py-1 rounded hover:bg-blue-200 transition-colors flex items-center gap-1">
                                <i class="fas fa-plus-circle"></i> <span id="extract-text">å¢é‡èƒå–</span>
                            </button>
                            <div class="tooltip-content hidden absolute right-0 top-8 w-64 bg-slate-800 text-white text-xs p-3 rounded shadow-lg z-50 leading-relaxed">
                                <b>å¢é‡èƒå–ï¼š</b><br>åŸºäºå½“å‰å¯¹è¯ï¼Œæ€»ç»“æœ¬æ­¥éª¤çš„æ ¸å¿ƒè¦ç‚¹ï¼Œå¹¶<b>è¿½åŠ </b>åˆ°ä¸‹æ–¹è¾“å…¥æ¡†çš„æœ«å°¾ï¼Œä¸ä¼šè¦†ç›–ä½ å·²æœ‰çš„æ‰‹åŠ¨è®°å½•ã€‚
                            </div>
                        </div>
                    </div>
                </div>
                <textarea id="current-input" class="flex-1 p-6 resize-none outline-none text-slate-700 leading-relaxed text-base font-sans focus:bg-slate-50 transition-colors" placeholder="åœ¨æ­¤è®°å½•ä½ çš„ç»“è®ºï¼Œæˆ–æ‰‹åŠ¨è¾“å…¥çµæ„Ÿ..." spellcheck="false"></textarea>
                <div class="p-4 border-t border-slate-100 flex justify-between items-center flex-shrink-0">
                    <button onclick="app.prevStep()" id="btn-prev" class="text-slate-500 hover:text-slate-800 text-sm px-3 py-1">
                        <i class="fas fa-arrow-left mr-1"></i> ä¸Šä¸€æ­¥
                    </button>
                    <button onclick="app.nextStep()" id="btn-next" class="bg-slate-900 text-white px-4 py-2 rounded-lg text-sm hover:bg-slate-700 transition-colors shadow-lg shadow-slate-200">
                        ä¸‹ä¸€æ­¥ <i class="fas fa-arrow-right ml-1"></i>
                    </button>
                </div>
            </div>

            <!-- Right: AI Consultant -->
            <div class="w-1/2 flex flex-col bg-slate-50/50 relative transition-all duration-300" id="right-panel">
                <!-- API Chat Mode UI -->
                <div id="ai-mode-chat" class="flex flex-col h-full w-full absolute inset-0">
                    <div class="p-3 border-b border-slate-200 bg-white flex justify-between items-center shadow-sm z-10 flex-shrink-0">
                        <div class="flex items-center gap-2">
                            <div class="w-2 h-2 rounded-full bg-green-500 animate-pulse"></div>
                            <span class="text-sm font-bold text-slate-700" id="chat-header-title">CSO æ™ºèƒ½åŠ©ç†</span>
                        </div>
                        
                        <!-- Header Buttons (Dynamic based on Selection Mode) -->
                        <div class="flex items-center gap-2" id="chat-header-controls">
                            <!-- Normal Mode Buttons -->
                            <div id="normal-controls" class="flex items-center gap-2">
                                <button onclick="app.toggleSelectionMode()" class="text-slate-400 hover:text-blue-600 w-6 h-6 flex items-center justify-center rounded transition-colors" title="å¤šé€‰æ¨¡å¼ (å¯¼å‡ºç‰¹å®šå¯¹è¯)">
                                    <i class="fas fa-tasks"></i>
                                </button>
                                
                                <div class="relative">
                                    <button onclick="app.toggleChatExportMenu()" class="text-slate-400 hover:text-blue-600 w-6 h-6 flex items-center justify-center rounded transition-colors" title="å¯¼å‡ºå…¨éƒ¨å¯¹è¯">
                                        <i class="fas fa-download"></i>
                                    </button>
                                    <div id="chat-export-menu" class="dropdown-menu dropdown-hidden absolute right-0 top-8 w-40 bg-white rounded-lg shadow-xl border border-gray-100 z-50 overflow-hidden">
                                        <button onclick="app.copyChatHistory()" class="w-full text-left px-4 py-2 text-xs text-gray-700 hover:bg-gray-50 flex items-center gap-2">
                                            <i class="fas fa-copy text-slate-400 w-4"></i> å¤åˆ¶å…¨éƒ¨
                                        </button>
                                        <button onclick="app.exportChatMarkdown()" class="w-full text-left px-4 py-2 text-xs text-gray-700 hover:bg-gray-50 flex items-center gap-2 border-t border-gray-50">
                                            <i class="fas fa-file-code text-blue-400 w-4"></i> å¯¼å‡º MD
                                        </button>
                                    </div>
                                </div>
                                
                                <div class="w-px h-3 bg-slate-200"></div>
                                <button onclick="app.clearChat()" class="text-slate-400 hover:text-red-500 w-6 h-6 flex items-center justify-center rounded transition-colors" title="æ¸…ç©ºå†å²">
                                    <i class="fas fa-trash-alt"></i>
                                </button>
                            </div>

                            <!-- Selection Mode Buttons (Hidden by default) -->
                            <div id="selection-controls" class="hidden flex items-center gap-2">
                                <span class="text-xs text-blue-600 font-bold bg-blue-50 px-2 py-1 rounded" id="selection-count">å·²é€‰ 0</span>
                                <button onclick="app.copySelectedChat()" class="text-xs bg-white border border-slate-200 hover:bg-blue-50 text-slate-600 px-2 py-1 rounded transition-colors" title="å¤åˆ¶é€‰ä¸­">
                                    <i class="fas fa-copy"></i> å¤åˆ¶
                                </button>
                                <button onclick="app.exportSelectedChatMarkdown()" class="text-xs bg-white border border-slate-200 hover:bg-blue-50 text-slate-600 px-2 py-1 rounded transition-colors" title="å¯¼å‡ºé€‰ä¸­">
                                    <i class="fas fa-file-code"></i> å¯¼å‡º
                                </button>
                                <div class="w-px h-3 bg-slate-200"></div>
                                <button onclick="app.toggleSelectionMode()" class="text-slate-400 hover:text-slate-600 w-6 h-6 flex items-center justify-center rounded transition-colors" title="é€€å‡ºé€‰æ‹©">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                        </div>
                    </div>

                    <div id="chat-container" class="flex-1 overflow-y-auto p-4 space-y-4">
                        <!-- Chat history -->
                    </div>

                    <div class="p-4 bg-white border-t border-slate-200 flex-shrink-0">
                        <div class="relative">
                            <textarea id="chat-input" rows="1" class="w-full bg-slate-100 border-0 rounded-xl px-4 py-3 pr-12 text-sm focus:ring-2 focus:ring-blue-500 focus:bg-white resize-none shadow-inner" placeholder="è¾“å…¥å¯¹è¯... (Enter å‘é€)" onkeydown="app.handleChatKey(event)"></textarea>
                            <button onclick="app.sendMessage()" id="send-btn" class="absolute right-2 top-2 w-8 h-8 bg-blue-600 text-white rounded-lg flex items-center justify-center hover:bg-blue-700 transition-all shadow-md">
                                <i class="fas fa-paper-plane text-xs"></i>
                            </button>
                        </div>
                        <div class="text-center mt-2">
                            <p id="ai-status" class="text-[10px] text-slate-400 h-4"></p>
                        </div>
                    </div>
                </div>

                <!-- Web Iframe Mode UI -->
                <div id="ai-mode-web" class="flex flex-col h-full w-full absolute inset-0 hidden bg-white">
                    <div class="p-2 border-b border-slate-200 bg-gray-100 flex justify-between items-center flex-shrink-0">
                         <div class="flex items-center gap-2 text-xs text-slate-500 w-full">
                            <i class="fas fa-lock"></i>
                            <input type="text" id="browser-url-bar" class="bg-white border border-gray-300 rounded px-2 py-1 flex-1 text-xs" readonly>
                            <a href="#" onclick="app.openSettings()" class="hover:text-blue-600"><i class="fas fa-edit"></i> ä¿®æ”¹</a>
                        </div>
                    </div>
                    <div class="flex-1 relative bg-gray-50">
                        <iframe id="web-frame" src="" class="w-full h-full border-0" sandbox="allow-scripts allow-same-origin allow-forms allow-popups"></iframe>
                        <div id="iframe-placeholder" class="absolute inset-0 flex flex-col items-center justify-center bg-slate-50 text-slate-500 p-8 text-center hidden">
                            <i class="fas fa-globe-americas text-4xl mb-4 text-slate-300"></i>
                            <p class="mb-2 font-bold">ç½‘é¡µåŠ è½½åŒº</p>
                            <p class="text-xs max-w-xs">å¦‚æœæ˜¾ç¤ºä¸ºç©ºç™½ï¼Œè¯´æ˜è¯¥ç½‘ç«™ç¦æ­¢è¢«åµŒå…¥ã€‚</p>
                        </div>
                    </div>
                    <div class="p-2 bg-yellow-50 text-yellow-700 text-xs border-t border-yellow-200 text-center flex-shrink-0">
                        ç½‘é¡µæ¨¡å¼ä¸‹ï¼Œæ— æ³•è‡ªåŠ¨èƒå–ã€‚è¯·æ‰‹åŠ¨å¤åˆ¶å¯¹è¯ä¸­çš„ç»“è®ºç²˜è´´åˆ°å·¦ä¾§ã€‚
                    </div>
                </div>
            </div>
        </div>

        <!-- Report View -->
        <div id="report-view" class="hidden flex-1 overflow-y-auto p-8 bg-slate-100">
            <div class="max-w-4xl mx-auto bg-white rounded-xl shadow-xl min-h-[80vh] flex flex-col">
                <div class="p-10 border-b border-slate-100 text-center">
                    <h1 class="text-3xl font-bold text-slate-800">åœºæ™¯è¯Šæ–­ä¸è§£å†³æ–¹æ¡ˆä¹¦</h1>
                    <p class="text-slate-500 text-sm mt-2">Generated by AI CSO Workbench</p>
                    <h2 id="report-project-name" class="text-xl font-medium text-blue-600 mt-4"></h2>
                </div>
                <div id="report-content" class="p-10 space-y-8 flex-1"></div>
                <div class="p-6 bg-slate-50 rounded-b-xl flex justify-between items-center no-print">
                    <button onclick="app.editMode()" class="text-slate-600 hover:text-blue-600 font-medium flex items-center gap-2">
                        <i class="fas fa-pen"></i> è¿”å›ä¿®æ”¹
                    </button>
                    <div class="flex gap-3">
                         <button onclick="window.print()" class="px-5 py-2 rounded-lg border border-slate-300 bg-white text-slate-700 hover:bg-slate-50">
                            <i class="fas fa-print"></i> æ‰“å° / PDF
                        </button>
                        <button onclick="app.copyReport()" class="px-6 py-2 rounded-lg bg-blue-600 text-white hover:bg-blue-700 shadow-lg shadow-blue-500/30">
                            <i class="fas fa-copy"></i> å¤åˆ¶å…¨æ–‡
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <script>
        const PROVIDERS = {
            gemini: { name: "Google Gemini", type: "google", baseUrl: "", model: "gemini-2.5-flash-preview-09-2025", models: ["gemini-2.5-flash-preview-09-2025", "gemini-1.5-flash", "gemini-1.5-pro"] },
            openai: { name: "OpenAI", type: "openai", baseUrl: "https://api.openai.com/v1", model: "gpt-4o", models: ["gpt-4o", "gpt-4o-mini", "gpt-4-turbo"] },
            deepseek: { name: "DeepSeek", type: "openai", baseUrl: "https://api.deepseek.com", model: "deepseek-chat", models: ["deepseek-chat (V3 - é€šç”¨å¯¹è¯)", "deepseek-reasoner (R1 - æ·±åº¦æ¨ç†)"] },
            grok: { name: "Grok", type: "openai", baseUrl: "https://api.x.ai/v1", model: "grok-beta", models: ["grok-beta"] },
            qwen: { name: "Qwen", type: "openai", baseUrl: "https://dashscope.aliyuncs.com/compatible-mode/v1", model: "qwen-plus", models: ["qwen-plus", "qwen-turbo", "qwen-max"] },
            custom: { name: "Custom", type: "openai", baseUrl: "", model: "", models: [] }
        };

        const STEPS = [
            { phase: "ç¬¬ä¸€é˜¶æ®µï¼šåœºæ™¯æ˜¾å½±", title: "1. å‘ç°é—®é¢˜", systemPrompt: "ä½ ç°åœ¨çš„èº«ä»½æ˜¯é¦–å¸­åœºæ™¯å®˜ï¼ˆCSOï¼‰ä¸­çš„ã€æ•é”ä¾¦æ¢ã€‘ã€‚å½“å‰æ­¥éª¤æ˜¯ã€å‘ç°é—®é¢˜ã€‘ã€‚ä½ çš„ä»»åŠ¡æ˜¯å¼•å¯¼ç”¨æˆ·æè¿°é‚£äº›è®©ä»–è§‰å¾—'ä¸å¯¹åŠ²'çš„ç¬é—´ã€‚ä¸è¦æ€¥ç€åˆ†æåŸå› ï¼Œåªè¦æ•æ‰ä¿¡å·ã€‚è¯·é€šè¿‡æé—®å¼•å¯¼ç”¨æˆ·è¯´å‡ºå…·ä½“çš„ç°è±¡ã€è§¦å‘é¢‘ç‡å’Œåˆæ­¥æ„Ÿå—ã€‚æé—®è¦ç®€çŸ­æœ‰åŠ›ï¼ŒåƒèŠå®¶å¸¸ä¸€æ ·ã€‚", guideMsg: "ğŸ‘‹ å—¨ï¼Œæˆ‘æ˜¯ä½ çš„ CSO ä¾¦æ¢ã€‚å‘Šè¯‰æˆ‘ï¼Œæœ€è¿‘åœ¨å“ªä¸ªç¯èŠ‚è®©ä½ è§‰å¾—â€œä¸é¡ºæ‰‹â€æˆ–è€…â€œæ•ˆç‡ä½â€ï¼Ÿæˆ–è€…æœ‰æ²¡æœ‰å“ªä¸ªæ•°æ®æŒ‡æ ‡çªç„¶å¼‚å¸¸äº†ï¼Ÿåˆ«ç®¡åŸå› ï¼Œå…ˆæè¿°ä¸€ä¸‹ä½ çœ‹åˆ°çš„æ€ªäº‹ã€‚", placeholder: "åœ¨æ­¤è®°å½•é—®é¢˜çš„å…·ä½“è¡¨ç°..." },
            { phase: "ç¬¬ä¸€é˜¶æ®µï¼šåœºæ™¯æ˜¾å½±", title: "2. æ¢³ç†åœºæ™¯", systemPrompt: "ä½ ç°åœ¨çš„èº«ä»½æ˜¯é¦–å¸­åœºæ™¯å®˜ï¼ˆCSOï¼‰ä¸­çš„ã€åœºæ™¯ä¾§å†™å¸ˆã€‘ã€‚å½“å‰æ­¥éª¤æ˜¯ã€æ¢³ç†åœºæ™¯ã€‘ã€‚ä½ éœ€è¦å¼•å¯¼ç”¨æˆ·ç”¨ 5W1H æ–¹æ³•è¿˜åŸç°åœºã€‚è¯¢é—®ç”¨æˆ·ï¼šæ˜¯è°ï¼ˆWhoï¼‰ï¼Ÿåœ¨ä»€ä¹ˆç¯å¢ƒä¸‹ï¼ˆContextï¼‰ï¼Ÿæƒ³åšä»€ä¹ˆï¼ˆGoalï¼‰ï¼Ÿåšäº†ä»€ä¹ˆåŠ¨ä½œï¼ˆActionï¼‰ï¼Ÿ", guideMsg: "ğŸ” æ”¶åˆ°ã€‚ç°åœ¨æˆ‘ä»¬æŠŠé•œå¤´æ‹‰è¿‘ã€‚è¯·å¸®æˆ‘è¿˜åŸä¸€ä¸‹æ¡ˆå‘ç°åœºï¼šæ˜¯**è°**ï¼Œåœ¨**ä»€ä¹ˆæ ·çš„æƒ…å†µä¸‹**ï¼Œè¯•å›¾è¾¾æˆ**ä»€ä¹ˆç›®æ ‡**ï¼Ÿ", placeholder: "ç”¨æˆ·ï¼š\nç¯å¢ƒï¼š\nç›®æ ‡ï¼š\nåŠ¨ä½œï¼š" },
            { phase: "ç¬¬äºŒé˜¶æ®µï¼šæ·±åº¦è¯Šæ–­", title: "3. åˆ†æåœºæ™¯", systemPrompt: "ä½ ç°åœ¨çš„èº«ä»½æ˜¯é¦–å¸­åœºæ™¯å®˜ï¼ˆCSOï¼‰ä¸­çš„ã€å¤–ç§‘åŒ»ç”Ÿã€‘ã€‚å½“å‰æ­¥éª¤æ˜¯ã€åˆ†æåœºæ™¯ã€‘ã€‚å¼•å¯¼ç”¨æˆ·åˆ†æé˜»åŠ›æ¥æºã€‚æ˜¯å› ä¸ºæµç¨‹å¤ªé•¿ï¼ˆå†—ä½™ï¼‰ï¼Ÿè¿˜æ˜¯ä¿¡æ¯ä¸å¤Ÿï¼ˆæ–­å±‚ï¼‰ï¼Ÿè¿˜æ˜¯äººå²—ä¸åŒ¹é…ï¼ˆèƒ½åŠ›é”™ä½ï¼‰ï¼Ÿ", guideMsg: "ğŸ©º æ˜ç™½äº†ã€‚è®©æˆ‘ä»¬æ¥åšä¸ªæ‰‹æœ¯ã€‚ä½ è§‰å¾—ä¸ºä»€ä¹ˆè¿™ä¸ªæµç¨‹èµ°ä¸é€šï¼Ÿæ˜¯æ­¥éª¤å¤ªå¤šäº†ï¼Ÿè¿˜æ˜¯ç”¨æˆ·åœ¨è¿™ä¸ªèŠ‚ç‚¹ä¸Šç¼ºå°‘äº†å…³é”®ä¿¡æ¯å¯¼è‡´ä¸çŸ¥é“è¯¥å¹²å˜›ï¼Ÿ", placeholder: "é˜»åŠ›åˆ†æï¼š" },
            { phase: "ç¬¬äºŒé˜¶æ®µï¼šæ·±åº¦è¯Šæ–­", title: "4. æ‰¾åˆ°ç—›ç‚¹", systemPrompt: "ä½ ç°åœ¨çš„èº«ä»½æ˜¯é¦–å¸­åœºæ™¯å®˜ï¼ˆCSOï¼‰ä¸­çš„ã€å¿ƒç†ä¾§å†™å¸ˆã€‘ã€‚å½“å‰æ­¥éª¤æ˜¯ã€æ‰¾åˆ°ç—›ç‚¹ã€‘ã€‚è¿™ä¸€ç‚¹éå¸¸å…³é”®ã€‚ä½ éœ€è¦å¼•å¯¼ç”¨æˆ·åŒºåˆ†ã€æ˜¾æ€§ç—›ç‚¹ã€‘ï¼ˆå¦‚æŠ¥é”™ã€è¶…æ—¶ï¼‰å’Œã€éšæ€§ç—›ç‚¹ã€‘ï¼ˆå¦‚ç„¦è™‘ã€ä¸ä¿¡ä»»ã€æ€•éº»çƒ¦ï¼‰ã€‚éšæ€§ç—›ç‚¹å¾€å¾€æ›´é‡è¦ã€‚", guideMsg: "ğŸ¯ è®©æˆ‘ä»¬æŒ–å¾—å†æ·±ä¸€ç‚¹ã€‚é™¤äº†è¡¨é¢ä¸Šçš„æŠ¥é”™æˆ–è€…æ…¢ï¼ˆæ˜¾æ€§ç—›ç‚¹ï¼‰ï¼Œä½ è§‰å¾—ç”¨æˆ·å†…å¿ƒåœ¨é‚£ä¸ªç¬é—´æ˜¯ä»€ä¹ˆæ„Ÿå—ï¼Ÿæ˜¯ç„¦è™‘ï¼Ÿæ˜¯ä¸ä¿¡ä»»ï¼Ÿè¿˜æ˜¯å•çº¯çš„è§‰å¾—'å¿ƒç´¯'ï¼Ÿï¼ˆéšæ€§ç—›ç‚¹ï¼‰", placeholder: "æ˜¾æ€§ç—›ç‚¹ï¼š\néšæ€§ç—›ç‚¹ï¼š" },
            { phase: "ç¬¬ä¸‰é˜¶æ®µï¼šç ´å±€é‡æ„", title: "5. å‘ç°è§£å†³ä¹‹é“", systemPrompt: "ä½ ç°åœ¨çš„èº«ä»½æ˜¯é¦–å¸­åœºæ™¯å®˜ï¼ˆCSOï¼‰ä¸­çš„ã€æˆ˜ç•¥é¡¾é—®ã€‘ã€‚å½“å‰æ­¥éª¤æ˜¯ã€å‘ç°è§£å†³ä¹‹é“ã€‘ã€‚å¼•å¯¼ç”¨æˆ·å®šè°ƒå­ã€‚æ˜¯åšåŠ æ³•è¿˜æ˜¯å‡æ³•ï¼Ÿæ˜¯é æŠ€æœ¯è‡ªåŠ¨åŒ–è¿˜æ˜¯é ç®¡ç†æœºåˆ¶å˜é©ï¼Ÿ", guideMsg: "âš–ï¸ æ—¢ç„¶ç—…å› æ‰¾åˆ°äº†ï¼Œæˆ‘ä»¬æ€ä¹ˆå¼€æ–¹å­ï¼Ÿæ˜¯ç»™ç³»ç»Ÿåš**å‡æ³•**ï¼ˆç æ‰æµç¨‹ï¼‰ï¼Œè¿˜æ˜¯åš**åŠ æ³•**ï¼ˆå¢åŠ è¾…åŠ©åŠŸèƒ½ï¼‰ï¼Ÿæ˜¯é æŠ€æœ¯è§£å†³ï¼Œè¿˜æ˜¯é æ”¹åˆ¶åº¦è§£å†³ï¼Ÿ", placeholder: "æ ¸å¿ƒç­–ç•¥ï¼š" },
            { phase: "ç¬¬ä¸‰é˜¶æ®µï¼šç ´å±€é‡æ„", title: "6. æ¢ç´¢è§£å†³æ–¹æ¡ˆ", systemPrompt: "ä½ ç°åœ¨çš„èº«ä»½æ˜¯é¦–å¸­åœºæ™¯å®˜ï¼ˆCSOï¼‰ä¸­çš„ã€äº§å“æ¶æ„å¸ˆã€‘ã€‚å½“å‰æ­¥éª¤æ˜¯ã€æ¢ç´¢è§£å†³æ–¹æ¡ˆã€‘ã€‚å¼•å¯¼ç”¨æˆ·æ„æ€æ–¹æ¡ˆ Aï¼ˆMVPç‰ˆï¼Œå¿«é€Ÿè½åœ°ï¼‰å’Œæ–¹æ¡ˆ Bï¼ˆç»ˆæç‰ˆï¼Œç†æƒ³çŠ¶æ€ï¼‰ã€‚", guideMsg: "ğŸ’¡ åˆ«åªç»™ä¸€ä¸ªæ–¹æ¡ˆã€‚æ¥ï¼Œç»™æˆ‘ä¸€ä¸ª**ç°åœ¨é©¬ä¸Šèƒ½æ”¹çš„ä½æˆæœ¬æ–¹æ¡ˆ (MVP)**ï¼Œå†ç»™æˆ‘ä¸€ä¸ª**å¦‚æœä¸ç¼ºé’±ä¸ç¼ºäººæœ€å®Œç¾çš„ç†æƒ³æ–¹æ¡ˆ**ã€‚", placeholder: "æ–¹æ¡ˆ A (MVP)ï¼š\næ–¹æ¡ˆ B (Ideal)ï¼š" },
            { phase: "ç¬¬ä¸‰é˜¶æ®µï¼šç ´å±€é‡æ„", title: "7. å½¢æˆæœ€ç»ˆç»“æœ", systemPrompt: "ä½ ç°åœ¨çš„èº«ä»½æ˜¯é¦–å¸­åœºæ™¯å®˜ï¼ˆCSOï¼‰ä¸­çš„ã€äº¤ä»˜ç»ç†ã€‘ã€‚å½“å‰æ­¥éª¤æ˜¯ã€å½¢æˆæœ€ç»ˆç»“æœã€‘ã€‚å¼•å¯¼ç”¨æˆ·å®šä¹‰æˆåŠŸçš„æ ‡å‡†ã€‚äº¤ä»˜ç‰©æ˜¯ä»€ä¹ˆï¼Ÿé¢„æœŸæŒ‡æ ‡æå‡å¤šå°‘ï¼Ÿ", guideMsg: "ğŸ æœ€åä¸€æ­¥ï¼Œä»¥ç»ˆä¸ºå§‹ã€‚å¦‚æœè¿™äº‹å„¿æˆäº†ï¼Œæˆ‘ä»¬è¦äº¤ä»˜ä»€ä¹ˆä¸œè¥¿ï¼ˆPRD/è®¾è®¡ç¨¿/æ–°åˆ¶åº¦ï¼‰ï¼Ÿä½ é¢„æœŸçš„æ ¸å¿ƒæŒ‡æ ‡ä¼šæå‡å¤šå°‘ï¼Ÿ", placeholder: "äº¤ä»˜ç‰©ï¼š\né¢„æœŸæŒ‡æ ‡ï¼š" }
        ];

        const app = {
            currentStep: 0,
            isSelectionMode: false,
            selectedIndices: new Set(),
            settings: { mode: "api", webUrl: "", provider: "gemini", apiKey: "", baseUrl: "", modelName: "gemini-2.5-flash-preview-09-2025" },
            data: { projectName: "", steps: new Array(7).fill(""), chatHistory: [] },
            
            init() {
                mermaid.initialize({ startOnLoad: false, theme: 'default' });
                this.loadSettings();
                this.loadData();
                this.renderNav();
                this.updateModeUI();
                if (this.data.chatHistory.length === 0) {
                    this.data.chatHistory.push({ role: 'model', text: STEPS[0].guideMsg });
                }
                this.renderStep();
                
                document.getElementById('chat-input').addEventListener('input', function() {
                    this.style.height = 'auto'; this.style.height = (this.scrollHeight) + 'px';
                });
                document.getElementById('current-input').addEventListener('input', (e) => {
                    this.data.steps[this.currentStep] = e.target.value; this.saveData();
                });
                document.addEventListener('click', (e) => {
                    const exMenu = document.getElementById('export-menu');
                    if (!e.target.closest('button[onclick="app.toggleExportMenu()"]') && !exMenu.contains(e.target)) {
                        exMenu.classList.add('dropdown-hidden'); exMenu.classList.remove('dropdown-visible');
                    }
                    const chatExMenu = document.getElementById('chat-export-menu');
                    if (!e.target.closest('button[onclick="app.toggleChatExportMenu()"]') && !chatExMenu.contains(e.target)) {
                        chatExMenu.classList.add('dropdown-hidden'); chatExMenu.classList.remove('dropdown-visible');
                    }
                });
            },

            // --- Toggle Notes Panel ---
            toggleNotes() {
                const left = document.getElementById('left-panel');
                const right = document.getElementById('right-panel');
                const icon = document.getElementById('notes-toggle-icon');
                
                if (left.classList.contains('hidden')) {
                    // Show Notes
                    left.classList.remove('hidden');
                    right.classList.remove('w-full');
                    right.classList.add('w-1/2');
                    icon.className = 'fas fa-book-open text-lg text-blue-600'; // Active style
                } else {
                    // Hide Notes (Zen Mode)
                    left.classList.add('hidden');
                    right.classList.remove('w-1/2');
                    right.classList.add('w-full');
                    icon.className = 'fas fa-book text-lg text-slate-400'; // Inactive style
                }
            },

            // --- Selection Mode Logic ---
            toggleSelectionMode() {
                this.isSelectionMode = !this.isSelectionMode;
                this.selectedIndices.clear();
                
                // Toggle UI state
                document.getElementById('normal-controls').classList.toggle('hidden', this.isSelectionMode);
                document.getElementById('selection-controls').classList.toggle('hidden', !this.isSelectionMode);
                document.getElementById('chat-header-title').innerText = this.isSelectionMode ? "è¯·ç‚¹å‡»é€‰æ‹©æ°”æ³¡" : "CSO æ™ºèƒ½åŠ©ç†";
                
                // Toggle styles on container
                document.getElementById('chat-container').classList.toggle('selection-mode', this.isSelectionMode);
                
                // Refresh bubbles to clear styles
                this.renderStep();
            },

            handleMessageClick(index, el) {
                if (!this.isSelectionMode) return;
                
                if (this.selectedIndices.has(index)) {
                    this.selectedIndices.delete(index);
                    el.classList.remove('selected');
                } else {
                    this.selectedIndices.add(index);
                    el.classList.add('selected');
                }
                document.getElementById('selection-count').innerText = `å·²é€‰ ${this.selectedIndices.size}`;
            },

            copySelectedChat() {
                if (this.selectedIndices.size === 0) return alert("è¯·è‡³å°‘é€‰æ‹©ä¸€æ¡æ¶ˆæ¯");
                const selectedMsgs = this.data.chatHistory.filter((_, i) => this.selectedIndices.has(i));
                const text = this.formatChatHistory(selectedMsgs);
                navigator.clipboard.writeText(text).then(() => {
                    alert(`âœ… å·²å¤åˆ¶ ${this.selectedIndices.size} æ¡è®°å½•`);
                    this.toggleSelectionMode(); // Exit selection mode
                });
            },

            exportSelectedChatMarkdown() {
                if (this.selectedIndices.size === 0) return alert("è¯·è‡³å°‘é€‰æ‹©ä¸€æ¡æ¶ˆæ¯");
                const selectedMsgs = this.data.chatHistory.filter((_, i) => this.selectedIndices.has(i));
                const text = this.formatChatHistory(selectedMsgs);
                const blob = new Blob([text], { type: 'text/markdown' });
                const a = document.createElement('a');
                a.href = URL.createObjectURL(blob);
                a.download = `CSO_Selected_Chat_${new Date().toISOString().slice(0,10)}.md`;
                a.click();
                this.toggleSelectionMode();
            },

            // --- Existing Logic ---
            toggleChatExportMenu() {
                const el = document.getElementById('chat-export-menu');
                if (el.classList.contains('dropdown-hidden')) { el.classList.remove('dropdown-hidden'); el.classList.add('dropdown-visible'); } 
                else { el.classList.add('dropdown-hidden'); el.classList.remove('dropdown-visible'); }
            },
            formatChatHistory(messages = null) {
                const msgs = messages || this.data.chatHistory;
                if (!msgs || msgs.length === 0) return "";
                let text = `# ä¸ CSO çš„å¯¹è¯è®°å½• - ${this.data.projectName || 'æœªå‘½åé¡¹ç›®'}\n\n`;
                text += `> å¯¼å‡ºæ—¶é—´ï¼š${new Date().toLocaleString()}\n\n`;
                msgs.forEach(msg => {
                    if (msg.role === 'divider') { text += `\n--- ${msg.text} ---\n\n`; } 
                    else if (msg.role === 'user') { text += `**Me**: ${msg.text}\n\n`; } 
                    else { text += `**CSO**: ${msg.text}\n\n`; }
                });
                return text;
            },
            copyChatHistory() {
                const text = this.formatChatHistory();
                if (!text) return alert("æš‚æ— å¯¹è¯è®°å½•");
                navigator.clipboard.writeText(text).then(() => alert("âœ… å¯¹è¯è®°å½•å·²å¤åˆ¶"));
                this.toggleChatExportMenu();
            },
            exportChatMarkdown() {
                const text = this.formatChatHistory();
                if (!text) return alert("æš‚æ— å¯¹è¯è®°å½•");
                const blob = new Blob([text], { type: 'text/markdown' });
                const a = document.createElement('a');
                a.href = URL.createObjectURL(blob);
                a.download = `CSO_Chat_History_${new Date().toISOString().slice(0,10)}.md`;
                a.click();
                this.toggleChatExportMenu();
            },
            copyCurrentStep() {
                const text = this.data.steps[this.currentStep] || "";
                if (!text) return alert("å½“å‰æ²¡æœ‰å†…å®¹å¯å¤åˆ¶");
                navigator.clipboard.writeText(text).then(() => {
                    const btn = document.querySelector('button[title="å¤åˆ¶å½“å‰ç»“è®º"]');
                    const originalHTML = btn.innerHTML;
                    btn.innerHTML = '<i class="fas fa-check text-green-500"></i>';
                    setTimeout(() => btn.innerHTML = originalHTML, 1500);
                });
            },
            toggleExportMenu() {
                const el = document.getElementById('export-menu');
                if (el.classList.contains('dropdown-hidden')) { el.classList.remove('dropdown-hidden'); el.classList.add('dropdown-visible'); } else { el.classList.add('dropdown-hidden'); el.classList.remove('dropdown-visible'); }
            },
            exportMarkdown() {
                const text = this.data.steps[this.currentStep] || "";
                const title = STEPS[this.currentStep].title;
                const blob = new Blob([`# ${title}\n\n${text}`], { type: 'text/markdown' });
                const a = document.createElement('a');
                a.href = URL.createObjectURL(blob);
                a.download = `${title}.md`;
                a.click();
            },
            async generateMindMap() {
                if (this.settings.mode !== 'api') return alert("è¯·å…ˆåˆ‡æ¢åˆ° API æ¨¡å¼å¹¶é…ç½® Keyï¼Œæ‰èƒ½ä½¿ç”¨ AI ç”Ÿæˆè„‘å›¾ã€‚");
                const text = this.data.steps[this.currentStep] || "";
                if (!text || text.length < 5) return alert("è¯·å…ˆåœ¨å·¦ä¾§è¾“å…¥ä¸€äº›ç»“è®ºå†…å®¹ã€‚");
                document.getElementById('mindmap-modal').classList.remove('hidden');
                document.getElementById('mindmap-container').innerHTML = '<div class="text-gray-400 animate-pulse">AI æ­£åœ¨æ„å»ºæ€ç»´å¯¼å›¾...</div>';
                const prompt = `Convert the following text into a valid Mermaid.js mindmap syntax...`;
                 try {
                    this.setLoading(true, "ç”Ÿæˆå¯¼å›¾...");
                    let mermaidCode = "";
                    const provider = PROVIDERS[this.settings.provider];
                    if (provider.type === 'google') mermaidCode = await this.callGeminiAPI(`Convert to mermaid mindmap syntax. Only code. \n${text}`, []);
                    else mermaidCode = await this.callOpenAICompatibleAPI(`Convert to mermaid mindmap syntax. Only code. \n${text}`, []);
                    
                    mermaidCode = mermaidCode.replace(/```mermaid/g, '').replace(/```/g, '').trim();
                    if(!mermaidCode.startsWith('mindmap')) mermaidCode = `mindmap\n  root((${this.data.projectName || 'Idea'}))\n    ${text.slice(0,20)}...`; 

                    document.getElementById('mindmap-container').innerHTML = `<div class="mermaid">${mermaidCode}</div>`;
                    await mermaid.run();
                } catch (e) {
                    document.getElementById('mindmap-container').innerHTML = `<div class="text-red-500 p-4">ç”Ÿæˆå¤±è´¥: ${e.message}</div>`;
                }
                this.setLoading(false);
            },
            toggleSidebar() { document.getElementById('sidebar').classList.toggle('sidebar-hidden'); },
            loadSettings() { const s = localStorage.getItem('cso_settings_v24'); if (s) this.settings = { ...this.settings, ...JSON.parse(s) }; },
            saveSettings() { 
                const modeEls = document.getElementsByName('ai_mode');
                for(let el of modeEls) { if(el.checked) this.settings.mode = el.value; }
                this.settings.webUrl = document.getElementById('web-url-input').value.trim();
                this.settings.provider = document.getElementById('api-provider').value;
                this.settings.apiKey = document.getElementById('api-key-input').value.trim();
                this.settings.baseUrl = document.getElementById('api-base-url').value.trim();
                this.settings.modelName = document.getElementById('api-model-name').value.trim();
                localStorage.setItem('cso_settings_v24', JSON.stringify(this.settings));
                document.getElementById('settings-modal').classList.add('hidden');
                this.updateModeUI();
                this.renderStep();
            },
            openSettings() { 
                const modeEls = document.getElementsByName('ai_mode');
                for(let el of modeEls) { el.checked = (el.value === this.settings.mode); }
                document.getElementById('web-url-input').value = this.settings.webUrl || "";
                document.getElementById('api-provider').value = this.settings.provider || "gemini";
                document.getElementById('api-key-input').value = this.settings.apiKey || "";
                if(this.settings.baseUrl) document.getElementById('api-base-url').value = this.settings.baseUrl;
                if(this.settings.modelName) document.getElementById('api-model-name').value = this.settings.modelName;
                this.updateQuickSelect(this.settings.provider);
                this.toggleSettingsUI();
                document.getElementById('settings-modal').classList.remove('hidden');
            },
            handleProviderChange() { 
                const providerKey = document.getElementById('api-provider').value;
                const config = PROVIDERS[providerKey];
                document.getElementById('api-base-url').value = config.baseUrl;
                document.getElementById('api-model-name').value = config.model;
                document.getElementById('api-base-url').placeholder = (providerKey === 'gemini') ? "é»˜è®¤ (Google Cloud)" : config.baseUrl;
                this.updateQuickSelect(providerKey);
            },
            updateQuickSelect(k) { 
                const select = document.getElementById('model-quick-select');
                select.innerHTML = '';
                const models = PROVIDERS[k]?.models || [];
                if (models.length === 0) { const o = document.createElement('option'); o.text = "æš‚æ— æ¨è"; select.appendChild(o); select.disabled = true; return; }
                select.disabled = false;
                const def = document.createElement('option'); def.text = "-- ç‚¹å‡»é€‰æ‹© --"; def.value = ""; select.appendChild(def);
                models.forEach(m => { const op = document.createElement('option'); op.value = m.split(' ')[0]; op.text = m; select.appendChild(op); });
            },
            applyQuickModel() { const s = document.getElementById('model-quick-select'); if(s.value) document.getElementById('api-model-name').value = s.value; },
            toggleSettingsUI() { 
                const mode = Array.from(document.getElementsByName('ai_mode')).find(el => el.checked).value;
                document.getElementById('config-api').classList.toggle('hidden', mode !== 'api');
                document.getElementById('config-web').classList.toggle('hidden', mode !== 'web');
                document.getElementById('opt-api-label').classList.toggle('bg-blue-50', mode === 'api');
                document.getElementById('opt-api-label').classList.toggle('border-blue-500', mode === 'api');
                document.getElementById('opt-web-label').classList.toggle('bg-blue-50', mode === 'web');
                document.getElementById('opt-web-label').classList.toggle('border-blue-500', mode === 'web');
            },
            updateModeUI() { 
                const isApi = this.settings.mode === 'api';
                const providerName = PROVIDERS[this.settings.provider]?.name || "API";
                document.getElementById('mode-text').innerText = isApi ? `${providerName}` : "ç½‘é¡µæ¨¡å¼";
                document.getElementById('mode-icon').className = isApi ? "fas fa-bolt text-blue-500" : "fas fa-globe text-green-500";
                document.getElementById('chat-header-title').innerText = isApi ? `CSO åŠ©æ‰‹ (${providerName})` : "CSO åŠ©æ‰‹ (Web)";
                document.getElementById('ai-mode-chat').classList.toggle('hidden', !isApi);
                document.getElementById('ai-mode-web').classList.toggle('hidden', isApi);
                const btn = document.getElementById('extract-btn');
                const txt = document.getElementById('extract-text');
                if (isApi) { txt.innerText = "å¢é‡èƒå–"; btn.classList.remove('cursor-not-allowed', 'opacity-50'); btn.title = "å°†å¯¹è¯èƒå–å¹¶è¿½åŠ åˆ°å·¦ä¾§"; } 
                else { txt.innerText = "æ‰‹åŠ¨å¡«å…¥"; btn.classList.add('cursor-not-allowed', 'opacity-50'); btn.title = "ç½‘é¡µæ¨¡å¼ä¸‹è¯·æ‰‹åŠ¨å¤åˆ¶"; }
            },
            handleExtract() { if (this.settings.mode === 'web') alert("ğŸ“¢ ç½‘é¡µæ¨¡å¼æç¤ºï¼š\n\nè¯·æ‰‹åŠ¨ä»å³ä¾§ç½‘é¡µå¤åˆ¶ç»“è®ºï¼Œç²˜è´´åˆ°å·¦ä¾§è¾“å…¥æ¡†ä¸­ã€‚"); else this.generateFromChat(); },
            loadData() { 
                const saved = localStorage.getItem('cso_work_v24'); 
                if (saved) {
                    const parsed = JSON.parse(saved);
                    this.data.projectName = parsed.projectName || "";
                    this.data.steps = parsed.steps || new Array(7).fill("");
                    this.data.chatHistory = Array.isArray(parsed.chatHistory) ? parsed.chatHistory : [];
                }
                document.getElementById('project-name-header').value = this.data.projectName;
            },
            saveData() { 
                this.data.projectName = document.getElementById('project-name-header').value;
                localStorage.setItem('cso_work_v24', JSON.stringify(this.data));
                const icon = document.getElementById('save-icon');
                icon.classList.remove('text-slate-400');
                icon.classList.add('text-green-500');
                setTimeout(() => { icon.classList.add('text-slate-400'); icon.classList.remove('text-green-500'); }, 1000);
            },
            renderNav() { 
                const container = document.getElementById('nav-container');
                let html = '';
                let lastPhase = '';
                STEPS.forEach((step, index) => {
                    const phaseName = step.phase.split('ï¼š')[1];
                    if (phaseName !== lastPhase) { html += `<div class="px-4 mt-6 mb-2 text-xs font-bold text-slate-500 uppercase tracking-widest">${phaseName}</div>`; lastPhase = phaseName; }
                    const isActive = index === this.currentStep;
                    const hasContent = this.data.steps[index].length > 0;
                    const activeClass = isActive ? "bg-blue-600 text-white shadow-lg shadow-blue-900/50" : "text-slate-400 hover:bg-slate-800 hover:text-white";
                    const statusDot = hasContent ? `<div class="w-1.5 h-1.5 rounded-full bg-green-400 ml-auto"></div>` : "";
                    html += `<button onclick="app.goToStep(${index})" class="w-full text-left px-4 py-2.5 rounded-lg text-sm transition-all flex items-center ${activeClass}"><span class="mr-3 opacity-70">${index + 1}.</span>${step.title.split(' ')[1]}${statusDot}</button>`;
                });
                container.innerHTML = html;
            },
            renderStep() { 
                const step = STEPS[this.currentStep];
                document.getElementById('header-phase').innerText = step.phase;
                document.getElementById('header-step').innerText = step.title;
                document.getElementById('current-input').value = this.data.steps[this.currentStep];
                document.getElementById('current-input').placeholder = step.placeholder;

                if (this.settings.mode === 'web') {
                    const iframe = document.getElementById('web-frame');
                    if (this.settings.webUrl) {
                        if(iframe.src !== this.settings.webUrl) iframe.src = this.settings.webUrl;
                        document.getElementById('browser-url-bar').value = this.settings.webUrl;
                        document.getElementById('iframe-placeholder').classList.add('hidden');
                    } else {
                        iframe.src = "";
                        document.getElementById('browser-url-bar').value = "æœªé…ç½® URL";
                        document.getElementById('iframe-placeholder').classList.remove('hidden');
                    }
                } else {
                    const chatContainer = document.getElementById('chat-container');
                    chatContainer.innerHTML = ''; 
                    this.data.chatHistory.forEach((msg, index) => { // Updated to pass index
                        if (msg.role === 'divider') this.appendDividerToUI(msg.text, index); 
                        else this.appendMessageToUI(msg.role, msg.text, index);
                    });
                    this.scrollToBottom();
                }
                this.renderNav();
            },
            goToStep(idx) { 
                if (idx === this.currentStep) return;
                document.getElementById('editor-view').style.display = 'flex';
                document.getElementById('report-view').style.display = 'none';
                const newStepTitle = STEPS[idx].title.split(' ')[1];
                const dividerText = `è¿›å…¥æ­¥éª¤ ${idx + 1}: ${newStepTitle}`;
                this.data.chatHistory.push({ role: 'divider', text: dividerText });
                this.currentStep = idx;
                this.saveData(); 
                this.renderStep();
            },
            nextStep() { if(this.currentStep < STEPS.length - 1) this.goToStep(this.currentStep + 1); else this.showReport(); },
            prevStep() { if(this.currentStep > 0) this.goToStep(this.currentStep - 1); },
            handleChatKey(e) { if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); this.sendMessage(); } },
            
            async sendMessage() { 
                const input = document.getElementById('chat-input');
                const text = input.value.trim();
                if (!text) return;
                if (!this.settings.apiKey) { alert("âš ï¸ æœªé…ç½® API Key"); this.openSettings(); return; }
                input.value = ''; input.style.height = 'auto';
                this.data.chatHistory.push({ role: 'user', text: text });
                this.appendMessageToUI('user', text, this.data.chatHistory.length - 1); // Pass index
                this.scrollToBottom();
                this.saveData();
                this.setLoading(true);
                try {
                    const provider = PROVIDERS[this.settings.provider];
                    let responseText = "";
                    const apiHistory = this.data.chatHistory.filter(m => m.role !== 'divider');
                    if (provider.type === 'google') responseText = await this.callGeminiAPI(text, apiHistory);
                    else responseText = await this.callOpenAICompatibleAPI(text, apiHistory);
                    this.data.chatHistory.push({ role: 'model', text: responseText });
                    this.appendMessageToUI('model', responseText, this.data.chatHistory.length - 1); // Pass index
                    this.saveData();
                } catch (err) { this.appendMessageToUI('model', `ğŸš« è¯·æ±‚å¤±è´¥: ${err.message}`, -1); }
                this.setLoading(false);
            },
            async callGeminiAPI(userMsg, history) { 
                const step = STEPS[this.currentStep];
                const recentHistory = history.slice(-30).map(msg => ({ role: msg.role === 'model' ? 'model' : 'user', parts: [{ text: msg.text }] }));
                const payload = { contents: [ { role: "user", parts: [{ text: `System Instruction: You are currently assisting with "${step.title}". ${step.systemPrompt} \n(Previous context is preserved for continuity).` }] }, ...recentHistory ] };
                const model = this.settings.modelName || "gemini-2.5-flash-preview-09-2025";
                const url = `https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${this.settings.apiKey}`;
                const res = await fetch(url, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                if (!res.ok) throw new Error((await res.json()).error?.message || res.statusText);
                return (await res.json()).candidates[0].content.parts[0].text;
            },
            async callOpenAICompatibleAPI(userMsg, history) { 
                const step = STEPS[this.currentStep];
                const messages = [ { role: "system", content: `You are currently assisting with "${step.title}". ${step.systemPrompt}` }, ...history.slice(-30).map(msg => ({ role: msg.role === 'model' ? 'assistant' : 'user', content: msg.text })) ];
                const payload = { model: this.settings.modelName, messages: messages, temperature: 0.7 };
                let baseUrl = this.settings.baseUrl;
                if (baseUrl.endsWith('/')) baseUrl = baseUrl.slice(0, -1);
                const url = `${baseUrl}/chat/completions`;
                const res = await fetch(url, { method: 'POST', headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${this.settings.apiKey}` }, body: JSON.stringify(payload) });
                if (!res.ok) throw new Error((await res.json()).error?.message || res.statusText);
                return (await res.json()).choices[0].message.content;
            },
            async generateFromChat() { 
                if (!this.settings.apiKey) { this.openSettings(); return; }
                const history = this.data.chatHistory.filter(m => m.role !== 'divider');
                if (history.length < 2) { alert("è¯·å…ˆå’Œ AI èŠå‡ å¥"); return; }
                this.setLoading(true, "AI æ­£åœ¨èƒå–æœ¬ç¯èŠ‚è¦ç‚¹...");
                const prompt = `Based on our entire conversation history, specifically summarize the key findings and conclusions for the current step: "${STEPS[this.currentStep].title}". Output in clear, structured Chinese Markdown. Do not include conversational filler.`;
                try {
                    let responseText = "";
                    const provider = PROVIDERS[this.settings.provider];
                    const tempHistory = [...history.slice(-50), { role: 'user', text: prompt }];
                    if (provider.type === 'google') responseText = await this.callGeminiAPI(prompt, tempHistory);
                    else responseText = await this.callOpenAICompatibleAPI(prompt, tempHistory);
                    const currentVal = document.getElementById('current-input').value;
                    const timestamp = new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                    const appendText = `\n\n> ğŸ¤– **AI èƒå–å»ºè®® (${timestamp})**\n-------------------\n${responseText}\n`;
                    const finalVal = currentVal ? currentVal + appendText : responseText;
                    document.getElementById('current-input').value = finalVal;
                    const textarea = document.getElementById('current-input');
                    textarea.scrollTop = textarea.scrollHeight;
                    this.data.steps[this.currentStep] = finalVal;
                    this.saveData();
                } catch (e) { alert("èƒå–å¤±è´¥: " + e.message); }
                this.setLoading(false);
            },
            appendMessageToUI(role, text, index) { // Updated to accept index
                const container = document.getElementById('chat-container');
                const div = document.createElement('div');
                div.className = `chat-bubble p-3 text-sm shadow-sm ${role === 'user' ? 'user' : 'ai prose'}`;
                
                // Binding click event for selection
                if (index !== undefined && index !== -1) {
                    div.setAttribute('data-index', index);
                    div.onclick = (e) => this.handleMessageClick(index, e.currentTarget);
                }

                if (role === 'model') div.innerHTML = marked.parse(text); else div.innerText = text;
                
                // Re-apply selection style if currently selected (needed for re-renders)
                if (this.isSelectionMode && this.selectedIndices.has(index)) {
                    div.classList.add('selected');
                }

                container.appendChild(div);
            },
            appendDividerToUI(text, index) { 
                const container = document.getElementById('chat-container');
                const div = document.createElement('div');
                div.className = 'chat-divider';
                div.innerText = text;
                // Optional: allow selecting dividers too? Usually not needed, but index needs to match
                // If you want dividers selectable, add onclick here too.
                container.appendChild(div);
            },
            scrollToBottom() { const c = document.getElementById('chat-container'); setTimeout(() => c.scrollTop = c.scrollHeight, 50); },
            setLoading(isLoading, msg = "AI æ€è€ƒä¸­...") { document.getElementById('ai-status').innerHTML = isLoading ? `<div class="typing-indicator"><span></span><span></span><span></span></div> ${msg}` : ''; },
            clearChat() { if(confirm("ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰å¯¹è¯å†å²å—ï¼Ÿ(æ— æ³•æ¢å¤)")) { this.data.chatHistory = []; this.data.chatHistory.push({ role: 'model', text: STEPS[0].guideMsg }); this.saveData(); this.renderStep(); } },
            showReport() { 
                document.getElementById('editor-view').style.display = 'none';
                document.getElementById('report-view').style.display = 'block';
                document.getElementById('sidebar').classList.remove('sidebar-hidden');
                document.getElementById('report-project-name').innerText = this.data.projectName || "æœªå‘½åé¡¹ç›®";
                let html = '';
                STEPS.forEach((step, index) => {
                    const content = this.data.steps[index] || "ï¼ˆæœªå¡«å†™ï¼‰";
                    html += `<div class="border-b border-slate-200 pb-6 mb-6"><h3 class="text-sm font-bold text-blue-600 uppercase mb-3">${index+1}. ${step.title.split(' ')[1]}</h3><div class="prose max-w-none text-slate-700 text-sm pl-4">${marked.parse(content)}</div></div>`;
                });
                document.getElementById('report-content').innerHTML = html;
            },
            editMode() { document.getElementById('editor-view').style.display = 'flex'; document.getElementById('report-view').style.display = 'none'; this.renderStep(); },
            copyReport() { const text = STEPS.map((s, i) => `ã€${s.title}ã€‘\n${this.data.steps[i] || 'æœªå¡«å†™'}`).join('\n\n'); navigator.clipboard.writeText(text).then(() => alert('âœ… æŠ¥å‘Šå·²å¤åˆ¶')); }
        };

        app.init();
    </script>
</body>
</html>