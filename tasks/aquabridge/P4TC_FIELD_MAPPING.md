# P4TC现货应用决策字段映射文档

## 数据字段说明

### 1. 交易建议相关字段

| 字段名 | 数据位置 | 示例值 | 说明 |
|--------|---------|--------|------|
| 交易方向 | 第2-3行 | "做空" / "做多" | 建议的交易方向 |
| 盈亏比 | 第2行 | "3.33：1" | 盈亏比例 |
| 日期 | 第3行 | "2025-10-16" | 当前日期 |
| 当期值 | 第3行 | "15097" | 当前价格值 |
| 价差比 | 第3行 | "-5%" | 价差百分比 |

### 2. 预测数据相关字段

| 字段名 | 数据位置 | 示例值 | 说明 |
|--------|---------|--------|------|
| 建议交易方向 | 第5行 | "建议交易方向" | 标签 |
| 价差比区间 | 第5行 | "-15% - 0%" | 价差比范围 |
| 预测值 | 第5行 | "14418" | 预测价格值 |
| 出现概率 | 第5行 | "30%" | 概率百分比 |
| 预测日期 | 第6行 | "2025-11-27预测值" | 预测目标日期 |

### 3. 历史预测数据

| 字段名 | 数据位置 | 示例值 | 说明 |
|--------|---------|--------|------|
| 历史日期列表 | 第7-8行 | ["2025-10-23", "2025-10-30", ...] | 历史预测日期 |
| 历史预测值 | 第9行 | ["14970", "17462", ...] | 对应的预测值 |

### 4. 正收益统计

| 字段名 | 数据位置 | 示例值 | 说明 |
|--------|---------|--------|------|
| 最终正收益占比 | 第7行 | "71%" | 正收益占比 |
| 最终正收益平均值 | 第7行 | "16%" | 正收益平均值 |
| 正收益分布0～15% | 第9行 | "48%" | 分布比例 |
| 正收益分布15.01～30% | 第9行 | "42%" | 分布比例 |
| 正收益分布30～60% | 第9行 | "9%" | 分布比例 |
| 正收益分布>60% | 第9行 | "0%" | 分布比例 |
| 最大正收益平均值 | 第11行 | "20%" | 最大正收益平均值 |
| 最大正收益最大值 | 第11行 | "42%" | 最大正收益最大值 |
| 最大正收益出现时间平均值 | 第11行 | "30" | 天数 |
| 0～14天内出现比例 | 第13行 | "20%" | 时间分布 |
| 15～28天内出现比例 | 第13行 | "35%" | 时间分布 |
| 29～42天内出现比例 | 第13行 | "45%" | 时间分布 |

### 5. 负收益统计

| 字段名 | 数据位置 | 示例值 | 说明 |
|--------|---------|--------|------|
| 最终负收益比例 | 第13行 | "29%" | 负收益比例 |
| 最终负收益平均值 | 第13行 | "-11%" | 负收益平均值 |
| 负收益分布0～15% | 第15行 | "85%" | 分布比例 |
| 负收益分布15.01～30% | 第15行 | "0%" | 分布比例 |
| 负收益分布30～60% | 第15行 | "15%" | 分布比例 |
| 负收益分布<60% | 第15行 | "0%" | 分布比例 |
| 最小负收益平均值 | 第17行 | "-20%" | 最小负收益平均值 |
| 最小负收益最小值 | 第17行 | "-44%" | 最小负收益最小值 |

### 6. 模型评价数据

| 字段名 | 数据位置 | 示例值 | 说明 |
|--------|---------|--------|------|
| 当前价格 | 模型评价部分 | "15097" | 当前价格/元每吨 |
| 预测42天后价差 | 模型评价部分 | "-679" | 价差/元每吨 |
| 预测42天后价格 | 模型评价部分 | "14418" | 预测价格/元每吨 |
| 价差比 | 模型评价部分 | "-5%" | 价差百分比 |
| 历史判断正确率 | 各区间 | "100.00%", "95.65%", ... | 不同区间的准确率 |
| 历史预测实际值 | 各区间 | "-5304", "-4006", ... | 实际值 |
| 历史预测拟合值 | 各区间 | "-6110", "-3705", ... | 拟合值 |

## 数据验证检查点

### 必需字段检查
1. ✓ 交易方向（做多/做空）
2. ✓ 盈亏比
3. ✓ 日期
4. ✓ 当期值
5. ✓ 价差比
6. ✓ 预测值
7. ✓ 出现概率

### 数据完整性检查
1. ✓ 数据行数 >= 20
2. ✓ 包含P4TC关键词
3. ✓ 包含日期格式数据
4. ✓ 包含百分比数据
5. ✓ 包含数值数据

### 字段映射验证
- 使用 `enhanced_formatter.py` 中的 `_extract_p4tc_data` 方法
- 使用 `p4tc_parser.py` 中的 `P4TCParser` 类进行结构化解析
- 验证解析后的数据是否包含所有关键字段

## 数据提取流程

1. **原始数据提取** (`extract_table_data`)
   - 从页面提取所有可见文本
   - 组织成行和列的格式
   - 保存为 `raw_table_data`

2. **数据格式化** (`format_data`)
   - 调用 `_extract_p4tc_data` 方法
   - 保存原始表格数据
   - 检测数据格式（P4TC vs FFA）

3. **结构化解析** (`P4TCParser.parse_p4tc_data`)
   - 解析交易建议 (`trading_recommendation`)
   - 解析当前预测 (`current_forecast`)
   - 解析历史预测 (`historical_forecasts`)
   - 解析正收益统计 (`positive_returns`)
   - 解析负收益统计 (`negative_returns`)
   - 解析模型评价 (`model_evaluation`)

## 常见问题

### 问题1: 未找到表格
**原因**: 页面可能使用div/span等元素而非table标签
**解决**: 已增强 `extract_table_data` 方法，支持多种数据格式

### 问题2: 数据字段缺失
**原因**: 页面结构变化或数据未完全加载
**解决**: 增加等待时间，动态检测数据加载完成

### 问题3: 字段映射错误
**原因**: 数据格式变化
**解决**: 使用关键词匹配和正则表达式进行灵活解析

