<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æœ€ç»ˆæµ‹è¯•é¡µé¢</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        .debug-panel {
            position: fixed;
            top: 10px;
            right: 10px;
            width: 350px;
            max-height: 500px;
            background: rgba(0,0,0,0.9);
            color: white;
            padding: 15px;
            border-radius: 8px;
            font-size: 12px;
            z-index: 9999;
            overflow-y: auto;
        }
        .debug-panel h6 {
            color: #00ff00;
            margin-bottom: 10px;
        }
        .debug-log {
            background: #000;
            padding: 5px;
            border-radius: 3px;
            margin: 2px 0;
            font-family: monospace;
        }
        .error { color: #ff6b6b; }
        .success { color: #51cf66; }
        .warning { color: #ffd43b; }
        .info { color: #74c0fc; }
        .test-button {
            margin: 5px;
        }
    </style>
</head>
<body>
    <div class="container mt-4">
        <h2>æœ€ç»ˆæµ‹è¯•é¡µé¢ - ç›ˆäºæ›²çº¿é—®é¢˜æ’æŸ¥</h2>
        <p class="text-muted">è¿™ä¸ªé¡µé¢ç”¨äºæœ€ç»ˆæµ‹è¯•ç›ˆäºæ›²çº¿æ ‡ç­¾çš„é—®é¢˜</p>
        
        <!-- è°ƒè¯•é¢æ¿ -->
        <div class="debug-panel">
            <h6>ğŸ” å®æ—¶è°ƒè¯•ä¿¡æ¯</h6>
            <div id="debugLogs"></div>
            <button class="btn btn-sm btn-outline-light mt-2" onclick="clearLogs()">æ¸…ç©ºæ—¥å¿—</button>
        </div>
        
        <!-- æµ‹è¯•æŒ‰é’® -->
        <div class="mb-4">
            <h5>æµ‹è¯•æŒ‰é’®</h5>
            <button class="btn btn-primary test-button" onclick="testLoadPnLCharts()">æµ‹è¯•åŠ è½½ç›ˆäºæ›²çº¿</button>
            <button class="btn btn-secondary test-button" onclick="testHidePnLCharts()">æµ‹è¯•éšè—ç›ˆäºæ›²çº¿</button>
            <button class="btn btn-info test-button" onclick="checkElements()">æ£€æŸ¥å…ƒç´ çŠ¶æ€</button>
            <button class="btn btn-warning test-button" onclick="testTabSwitch()">æµ‹è¯•æ ‡ç­¾åˆ‡æ¢</button>
        </div>
        
        <!-- æ ‡ç­¾å¯¼èˆª -->
        <ul class="nav nav-tabs" id="myTab" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="positions-tab" data-bs-toggle="tab" data-bs-target="#positions" type="button" role="tab">
                    æŒä»“æ±‡æ€»
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="history-tab" data-bs-toggle="tab" data-bs-target="#history" type="button" role="tab">
                    äº¤æ˜“è®°å½•
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="settlement-tab" data-bs-toggle="tab" data-bs-target="#settlement" type="button" role="tab">
                    ç»“ç®—å•
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="pnl-curve-tab" data-bs-toggle="tab" data-bs-target="#pnl-curve" type="button" role="tab">
                    ç›ˆäºæ›²çº¿
                </button>
            </li>
        </ul>
        
        <!-- æ ‡ç­¾å†…å®¹ -->
        <div class="tab-content" id="myTabContent">
            <!-- æŒä»“æ±‡æ€» -->
            <div class="tab-pane fade" id="positions" role="tabpanel">
                <div class="card mt-3">
                    <div class="card-body">
                        <h5>æŒä»“æ±‡æ€»å†…å®¹</h5>
                        <p>è¿™æ˜¯æŒä»“æ±‡æ€»é¡µé¢çš„å†…å®¹</p>
                    </div>
                </div>
            </div>
            
            <!-- äº¤æ˜“è®°å½• -->
            <div class="tab-pane fade" id="history" role="tabpanel">
                <div class="card mt-3">
                    <div class="card-body">
                        <h5>äº¤æ˜“è®°å½•å†…å®¹</h5>
                        <p>è¿™æ˜¯äº¤æ˜“è®°å½•é¡µé¢çš„å†…å®¹</p>
                    </div>
                </div>
            </div>
            
            <!-- ç»“ç®—å• -->
            <div class="tab-pane fade" id="settlement" role="tabpanel">
                <div class="card mt-3">
                    <div class="card-body">
                        <h5>ç»“ç®—å•å†…å®¹</h5>
                        <p>è¿™æ˜¯ç»“ç®—å•é¡µé¢çš„å†…å®¹</p>
                    </div>
                </div>
            </div>
            
            <!-- ç›ˆäºæ›²çº¿ -->
            <div class="tab-pane fade" id="pnl-curve" role="tabpanel">
                <!-- åˆå§‹å ä½ç¬¦ -->
                <div id="pnlPlaceholder" class="text-center py-5">
                    <div class="mb-4">
                        <i class="fas fa-chart-line fa-4x text-muted opacity-50"></i>
                    </div>
                    <h5 class="text-muted mb-3">ç‚¹å‡»ä¸Šæ–¹æ ‡ç­¾åŠ è½½ç›ˆäºæ›²çº¿</h5>
                    <p class="text-muted">å®æ—¶ç›‘æ§æ‚¨çš„äº¤æ˜“ç›ˆäºå˜åŒ–è¶‹åŠ¿</p>
                </div>
                
                <!-- åŠ è½½çŠ¶æ€ -->
                <div class="loading" id="pnlLoading" style="display: none;">
                    <div class="spinner-border" role="status">
                        <span class="visually-hidden">åŠ è½½ä¸­...</span>
                    </div>
                    <p class="mt-2">æ­£åœ¨åŠ è½½å›¾è¡¨æ•°æ®...</p>
                </div>
                
                <!-- å›¾è¡¨å®¹å™¨ -->
                <div id="pnlChartsContainer" style="display: none;">
                    <!-- å›¾è¡¨1ï¼šå®æ—¶æµ®åŠ¨ç›ˆäºæ›²çº¿ -->
                    <div class="row mb-4" id="floatingChartContainer">
                        <div class="col-12">
                            <div class="card chart-card shadow-sm">
                                <div class="card-header bg-primary text-white">
                                    <h6 class="mb-0"><i class="fas fa-chart-area"></i> å®æ—¶æµ®åŠ¨ç›ˆäºæ›²çº¿</h6>
                                    <small class="text-light">æ˜¾ç¤ºæ‰€æœ‰æœªå¹³ä»“å¤´å¯¸çš„æµ®åŠ¨ç›ˆäºå˜åŒ–</small>
                                </div>
                                <div class="card-body">
                                    <div class="chart-container">
                                        <canvas id="floatingPnLChart"></canvas>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- å›¾è¡¨2ï¼šç´¯è®¡å®é™…ç›ˆäºæ›²çº¿ -->
                    <div class="row" id="cumulativeChartContainer">
                        <div class="col-12">
                            <div class="card chart-card shadow-sm">
                                <div class="card-header bg-success text-white">
                                    <h6 class="mb-0"><i class="fas fa-chart-line"></i> ç´¯è®¡å®é™…ç›ˆäºæ›²çº¿</h6>
                                    <small class="text-light">æ˜¾ç¤ºå·²å¹³ä»“äº¤æ˜“çš„ç´¯è®¡ç›ˆäºå˜åŒ–</small>
                                </div>
                                <div class="card-body">
                                    <div class="chart-container">
                                        <canvas id="cumulativePnLChart"></canvas>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let floatingPnLChart = null;
        let cumulativePnLChart = null;
        let currentAccountId = 1; // æ¨¡æ‹Ÿè´¦æˆ·ID
        let authToken = 'test-token'; // æ¨¡æ‹Ÿtoken
        
        // è°ƒè¯•æ—¥å¿—å‡½æ•°
        function logDebug(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logElement = document.createElement('div');
            logElement.className = `debug-log ${type}`;
            logElement.textContent = `[${timestamp}] ${message}`;
            
            const debugLogs = document.getElementById('debugLogs');
            debugLogs.appendChild(logElement);
            debugLogs.scrollTop = debugLogs.scrollHeight;
            
            console.log(`[DEBUG] ${message}`);
        }
        
        function clearLogs() {
            document.getElementById('debugLogs').innerHTML = '';
        }
        
        // æ¨¡æ‹ŸåŠ è½½ç›ˆäºæ›²çº¿å›¾è¡¨
        function loadPnLCharts() {
            logDebug('=== loadPnLCharts å¼€å§‹ ===', 'info');
            logDebug(`currentAccountId: ${currentAccountId}`, 'info');
            
            const placeholder = document.getElementById('pnlPlaceholder');
            const loading = document.getElementById('pnlLoading');
            const chartsContainer = document.getElementById('pnlChartsContainer');
            
            // æ£€æŸ¥å…ƒç´ æ˜¯å¦å­˜åœ¨
            if (!placeholder) {
                logDebug('âŒ pnlPlaceholder å…ƒç´ ä¸å­˜åœ¨', 'error');
                return;
            }
            if (!loading) {
                logDebug('âŒ pnlLoading å…ƒç´ ä¸å­˜åœ¨', 'error');
                return;
            }
            if (!chartsContainer) {
                logDebug('âŒ pnlChartsContainer å…ƒç´ ä¸å­˜åœ¨', 'error');
                return;
            }
            
            logDebug('âœ… æ‰€æœ‰å¿…éœ€å…ƒç´ éƒ½å­˜åœ¨', 'success');
            
            // éšè—å ä½ç¬¦ï¼Œæ˜¾ç¤ºåŠ è½½çŠ¶æ€
            placeholder.style.display = 'none';
            loading.style.display = 'block';
            logDebug('âœ… æ˜¾ç¤ºåŠ è½½çŠ¶æ€ï¼Œéšè—å ä½ç¬¦', 'success');
            
            // æ¨¡æ‹ŸAPIè°ƒç”¨
            setTimeout(() => {
                // æ˜¾ç¤ºå›¾è¡¨å®¹å™¨
                chartsContainer.style.display = 'block';
                loading.style.display = 'none';
                logDebug('âœ… æ˜¾ç¤ºå›¾è¡¨å®¹å™¨ï¼Œéšè—åŠ è½½çŠ¶æ€', 'success');
                
                // åˆ›å»ºæ¨¡æ‹Ÿå›¾è¡¨
                createMockCharts();
                
                logDebug('=== loadPnLCharts å®Œæˆ ===', 'success');
            }, 1000);
        }
        
        // éšè—ç›ˆäºæ›²çº¿å›¾è¡¨
        function hidePnLCharts() {
            logDebug('=== hidePnLCharts å¼€å§‹ ===', 'info');
            
            const chartsContainer = document.getElementById('pnlChartsContainer');
            const placeholder = document.getElementById('pnlPlaceholder');
            const loading = document.getElementById('pnlLoading');
            
            if (chartsContainer) chartsContainer.style.display = 'none';
            if (placeholder) placeholder.style.display = 'block';
            if (loading) loading.style.display = 'none';
            
            logDebug('âœ… éšè—å›¾è¡¨ï¼Œæ˜¾ç¤ºå ä½ç¬¦', 'success');
            logDebug('=== hidePnLCharts å®Œæˆ ===', 'info');
        }
        
        // åˆ›å»ºæ¨¡æ‹Ÿå›¾è¡¨
        function createMockCharts() {
            logDebug('å¼€å§‹åˆ›å»ºæ¨¡æ‹Ÿå›¾è¡¨', 'info');
            
            // æµ®åŠ¨ç›ˆäºå›¾è¡¨
            const floatingCtx = document.getElementById('floatingPnLChart');
            if (floatingCtx) {
                if (floatingPnLChart) floatingPnLChart.destroy();
                floatingPnLChart = new Chart(floatingCtx, {
                    type: 'line',
                    data: {
                        labels: ['10:00', '11:00', '12:00', '13:00', '14:00'],
                        datasets: [{
                            label: 'æµ®åŠ¨ç›ˆäº',
                            data: [100, 150, 200, 180, 220],
                            borderColor: 'rgb(75, 192, 192)',
                            backgroundColor: 'rgba(75, 192, 192, 0.2)',
                            tension: 0.1
                        }]
                    },
                    options: {
                        responsive: true,
                        scales: {
                            y: {
                                beginAtZero: true
                            }
                        }
                    }
                });
                logDebug('âœ… æµ®åŠ¨ç›ˆäºå›¾è¡¨åˆ›å»ºæˆåŠŸ', 'success');
            } else {
                logDebug('âŒ floatingPnLChart canvas ä¸å­˜åœ¨', 'error');
            }
            
            // ç´¯è®¡ç›ˆäºå›¾è¡¨
            const cumulativeCtx = document.getElementById('cumulativePnLChart');
            if (cumulativeCtx) {
                if (cumulativePnLChart) cumulativePnLChart.destroy();
                cumulativePnLChart = new Chart(cumulativeCtx, {
                    type: 'line',
                    data: {
                        labels: ['å‘¨ä¸€', 'å‘¨äºŒ', 'å‘¨ä¸‰', 'å‘¨å››', 'å‘¨äº”'],
                        datasets: [{
                            label: 'ç´¯è®¡ç›ˆäº',
                            data: [500, 600, 550, 700, 800],
                            borderColor: 'rgb(54, 162, 235)',
                            backgroundColor: 'rgba(54, 162, 235, 0.2)',
                            tension: 0.1
                        }]
                    },
                    options: {
                        responsive: true,
                        scales: {
                            y: {
                                beginAtZero: true
                            }
                        }
                    }
                });
                logDebug('âœ… ç´¯è®¡ç›ˆäºå›¾è¡¨åˆ›å»ºæˆåŠŸ', 'success');
            } else {
                logDebug('âŒ cumulativePnLChart canvas ä¸å­˜åœ¨', 'error');
            }
        }
        
        // æµ‹è¯•å‡½æ•°
        function testLoadPnLCharts() {
            logDebug('ğŸ§ª æ‰‹åŠ¨æµ‹è¯•åŠ è½½ç›ˆäºæ›²çº¿', 'warning');
            loadPnLCharts();
        }
        
        function testHidePnLCharts() {
            logDebug('ğŸ§ª æ‰‹åŠ¨æµ‹è¯•éšè—ç›ˆäºæ›²çº¿', 'warning');
            hidePnLCharts();
        }
        
        function checkElements() {
            logDebug('ğŸ” æ£€æŸ¥å…ƒç´ çŠ¶æ€', 'info');
            
            const elements = [
                'pnlPlaceholder',
                'pnlLoading', 
                'pnlChartsContainer',
                'floatingChartContainer',
                'cumulativeChartContainer',
                'floatingPnLChart',
                'cumulativePnLChart'
            ];
            
            elements.forEach(id => {
                const element = document.getElementById(id);
                if (element) {
                    const display = window.getComputedStyle(element).display;
                    logDebug(`${id}: å­˜åœ¨, display=${display}`, 'success');
                } else {
                    logDebug(`${id}: ä¸å­˜åœ¨`, 'error');
                }
            });
        }
        
        function testTabSwitch() {
            logDebug('ğŸ§ª æµ‹è¯•æ ‡ç­¾åˆ‡æ¢', 'warning');
            
            // æ¨¡æ‹Ÿç‚¹å‡»ç›ˆäºæ›²çº¿æ ‡ç­¾
            const pnlTab = document.getElementById('pnl-curve-tab');
            if (pnlTab) {
                pnlTab.click();
                logDebug('âœ… ç‚¹å‡»ç›ˆäºæ›²çº¿æ ‡ç­¾', 'success');
            } else {
                logDebug('âŒ ç›ˆäºæ›²çº¿æ ‡ç­¾ä¸å­˜åœ¨', 'error');
            }
        }
        
        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            logDebug('ğŸš€ é¡µé¢åŠ è½½å®Œæˆï¼Œåˆå§‹åŒ–äº‹ä»¶ç›‘å¬å™¨', 'success');
            
            // æ ‡ç­¾åˆ‡æ¢æ—¶åŠ è½½å¯¹åº”æ•°æ®
            document.querySelectorAll('[data-bs-toggle="tab"]').forEach(tab => {
                tab.addEventListener('shown.bs.tab', function(event) {
                    const target = event.target.getAttribute('data-bs-target');
                    logDebug(`ğŸ”„ åˆ‡æ¢åˆ°æ ‡ç­¾: ${target}`, 'info');
                    
                    if (target === '#positions') {
                        logDebug('ğŸ“Š åŠ è½½æŒä»“æ±‡æ€»æ•°æ®', 'info');
                    } else if (target === '#history') {
                        logDebug('ğŸ“‹ åŠ è½½äº¤æ˜“è®°å½•æ•°æ®', 'info');
                    } else if (target === '#settlement') {
                        logDebug('ğŸ“„ åŠ è½½ç»“ç®—å•æ•°æ®', 'info');
                    } else if (target === '#pnl-curve') {
                        logDebug('ğŸ“ˆ åŠ è½½ç›ˆäºæ›²çº¿å›¾è¡¨', 'info');
                        loadPnLCharts();
                    } else {
                        logDebug('ğŸ”„ åˆ‡æ¢åˆ°å…¶ä»–æ ‡ç­¾ï¼Œéšè—ç›ˆäºæ›²çº¿å›¾è¡¨', 'info');
                        hidePnLCharts();
                    }
                });
            });
            
            logDebug('âœ… äº‹ä»¶ç›‘å¬å™¨è®¾ç½®å®Œæˆ', 'success');
        });
    </script>
</body>
</html>
