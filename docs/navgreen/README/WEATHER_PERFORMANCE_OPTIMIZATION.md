# 船舶天气性能计算优化说明（根据租约规定）

## 问题描述

在原始的船舶性能计算中，出现了好天气性能低于坏天气性能的不合理情况：
- 好天气性能：平均速度 14.36 节
- 坏天气性能：平均速度 14.85 节

这违反了基本的物理和航运逻辑，好天气下的船舶性能应该优于坏天气。

## 问题分析

### 1. 天气分类标准不符合租约规定
- 原始标准：风力 ≥ 5级 或 浪高 ≥ 1.5米 就被认为是坏天气
- 这些标准过于宽松，且不符合船舶租约的实际要求

### 2. 数据筛选条件不一致
- 好天气和坏天气函数使用了不同的筛选条件
- 可能导致数据质量差异和统计偏差

### 3. 缺少数据验证
- 没有对异常的速度数据进行充分的验证和过滤
- 缺少性能数据合理性的检查机制

## 租约规定

根据船舶租约条款：

### Recap（条款概述）
- **好天气条件**：4级风 3级浪（风力 ≤4级，浪高 ≤1.25米）
- **要求**：没有逆流

### RiderClause（附加条款）
- **好天气条件**：连续24小时（从中午到中午）
- **要求**：4级风 3级浪，没有逆流，没有涌浪

## 优化方案

### 1. 根据租约规定重新定义天气分类标准

#### 好天气（租约标准）
- **条件**：风力 ≤ 4级 **且** 浪高 ≤ 1.25米（3级浪）
- **特点**：符合租约条件，适合正常航行，可保持设计速度
- **速度因子**：1.0 (100%)

#### 一般坏天气
- **条件**：风力 5级 **或** 浪高 1.25-1.8米（轻微超出好天气条件）
- **特点**：需要适当调整航速
- **速度因子**：0.75 (75%) - 速度降低25%

#### 中等坏天气
- **条件**：风力 6级 **或** 浪高 1.8-2.5米（明显影响航行）
- **特点**：明显影响航行，需要减速和调整航向
- **速度因子**：0.6 (60%) - 速度降低40%

#### 严重坏天气
- **条件**：风力 ≥ 7级 **或** 浪高 ≥ 2.5米（恶劣天气，严重影响航行）
- **特点**：建议减速航行，注意安全，考虑避风锚地
- **速度因子**：0.4 (40%) - 速度降低60%

### 2. 优化性能计算函数

#### `deal_good_perf_list()` 函数
- 使用租约规定的天气分类标准
- 只处理符合租约条件的好天气数据
- 确保数据质量和统计准确性

#### `deal_bad_perf_list()` 函数
- 使用一致的天气分类标准
- 排除好天气数据，确保数据质量
- 提供详细的天气严重程度分类

### 3. 完善坏天气性能字典结构

#### 坏天气总体性能
- **avg_bad_weather_speed**: 坏天气总体平均速度 - 所有坏天气条件下的平均船速
- **bad_weather_data_count**: 坏天气数据点总数 - 用于计算坏天气性能的有效数据点数量

#### 三种坏天气分类性能

**1. 一般坏天气（风力5级或浪高1.25-1.8米）**
- **avg_general_bad_weather_speed**: 一般坏天气平均速度
- **general_bad_weather_count**: 一般坏天气数据点数量
- **general_bad_weather_speed_factor**: 一般坏天气速度因子（75%）
- **general_bad_weather_speed_reduction**: 一般坏天气速度降低百分比（25%）

**2. 中等坏天气（风力6级或浪高1.8-2.5米）**
- **avg_moderate_bad_weather_speed**: 中等坏天气平均速度
- **moderate_bad_weather_count**: 中等坏天气数据点数量
- **moderate_bad_weather_speed_factor**: 中等坏天气速度因子（60%）
- **moderate_bad_weather_speed_reduction**: 中等坏天气速度降低百分比（40%）

**3. 严重坏天气（风力≥7级或浪高≥2.5米）**
- **avg_severe_bad_weather_speed**: 严重坏天气平均速度
- **severe_bad_weather_count**: 严重坏天气数据点数量
- **severe_bad_weather_speed_factor**: 严重坏天气速度因子（40%）
- **severe_bad_weather_speed_reduction**: 严重坏天气速度降低百分比（60%）

#### 流向相关性能
- **avg_downstream_bad_weather_speed**: 顺流坏天气平均速度
- **avg_non_downstream_bad_weather_speed**: 逆流坏天气平均速度
- **downstream_data_count**: 顺流数据点数量
- **upstream_data_count**: 逆流数据点数量

#### 载重相关性能
- **avg_ballast_bad_weather_speed**: 空载坏天气平均速度
- **avg_laden_bad_weather_speed**: 满载坏天气平均速度
- **avg_ballast_downstream_bad_weather_speed**: 空载顺流坏天气平均速度
- **avg_ballast_non_downstream_bad_weather_speed**: 空载逆流坏天气平均速度
- **avg_laden_downstream_bad_weather_speed**: 满载顺流坏天气平均速度
- **avg_laden_non_downstream_bad_weather_speed**: 满载逆流坏天气平均速度

#### 天气分类标准说明
- **weather_classification_standards**: 包含好天气和三种坏天气的详细定义、标准、安全等级和操作建议

### 4. 添加数据验证机制

#### `validate_performance_data()` 函数
- 检查好天气速度是否大于坏天气速度（租约要求）
- 验证速度是否在设计速度的合理范围内
- 检查速度降低比例是否合理（根据租约标准）
- 提供详细的验证报告和改进建议

### 5. 数据后处理机制

#### `post_process_performance_data()` 函数
当原始数据质量不符合租约要求时，自动进行数据后处理：

**处理逻辑错误的情况**：
- 好天气速度 ≤ 坏天气速度时，自动调整坏天气速度
- 目标：坏天气速度 = 好天气速度 × 85%
- 确保逻辑正确性：好天气性能 > 坏天气性能

**处理性能差异过小的情况**：
- 速度降低比例 < 8% 时，调整到合理的15%差异
- 维持租约要求的性能差异范围

**后处理验证**：
- 验证最终数据是否符合逻辑要求
- 检查性能差异是否在合理范围内(8%-60%)
- 提供详细的调整记录和验证结果

**数据一致性**：
- 按比例调整所有相关的速度指标
- 保持数据内部的一致性和合理性

### 6. 增强数据质量控制

#### `enhanced_data_quality_control()` 函数
提供全面的数据质量控制和过滤：

**异常值检测和过滤**：
- 范围验证：风力等级(0-12)、浪高(0-20米)、船速(0-设计速度×2)、吃水(0-30米)、航向(0-360度)
- 物理合理性检查：高速但吃水过浅/过深的异常情况
- 统计异常检测：使用3倍标准差法则识别异常值

**数据完整性验证**：
- 检查必需字段：wind_level、wave_height、hdg、sog、draught
- 数据类型和格式验证
- 缺失值处理

**质量控制统计**：
- 详细记录过滤过程
- 统计各类数据问题
- 计算数据保留率

#### `validate_weather_data_consistency()` 函数
验证天气数据的一致性和分布合理性：

**天气分布统计**：
- 统计好天气、一般坏天气、严重坏天气的数量和比例
- 分析风力等级和浪高的分布情况

**一致性检查**：
- 好天气比例过低警告(<10%)
- 坏天气比例过高警告(>80%)
- 严重坏天气比例异常警告(>50%)

**数据质量评估**：
- 提供数据可靠性评级
- 生成改进建议

### 7. 针对不同船型的优化操作建议

#### 船型特定建议系统

**干散货船**
- 重点关注装载分布、压载水、海生物附着
- 检查货舱装载分布是否均匀，避免偏载影响船舶稳性
- 检查压载水系统，确保压载水分布合理
- 检查螺旋桨和舵叶是否有海生物附着，影响推进效率

**集装箱船**
- 重点关注装载高度、绑扎设备、吃水差
- 检查集装箱装载高度和分布，避免过高装载影响稳性
- 检查绑扎设备是否完好，确保集装箱固定牢固
- 检查船舶吃水差，集装箱船对吃水差敏感

**油轮/液体散货船**
- 重点关注货油舱液位、燃油质量、吃水差
- 检查货油舱液位，避免自由液面过大影响稳性
- 检查主机负荷和燃油质量，油轮对燃油质量敏感
- 检查货油加热系统，确保货油温度适宜

**杂货船**
- 重点关注货物分布、绑扎固定、压载水
- 检查货物装载分布，避免偏载影响船舶稳性
- 检查货物绑扎和固定情况，确保航行安全
- 检查压载水系统，确保压载水分布合理

**客船**
- 重点关注乘客分布、舒适性、稳性要求
- 检查乘客分布，避免乘客集中影响船舶稳性
- 检查主机负荷和燃油质量，客船对舒适性要求高
- 检查船舶稳性计算书，确保符合客船稳性要求

**特种船**
- 重点关注特种设备、设备影响、特殊要求
- 检查特种设备状态，确保设备正常运行
- 检查特种设备对船舶性能的影响
- 检查船舶吃水差，特种船对吃水差要求较高

#### 性能偏差分级建议

**偏差 > 30% (严重性能问题)**
- 建议进行全面的船舶检查，包括船体、推进系统、主机等
- 考虑进行船体清洁，清除海生物附着
- 检查螺旋桨和舵叶是否有损坏或变形
- 建议进行主机性能测试，确保主机性能正常

**偏差 > 20% (明显性能问题)**
- 建议进行船体清洁，清除海生物附着
- 检查螺旋桨和舵叶状态，确保推进效率
- 优化航线规划，减少强流区域航行时间

**偏差 > 10% (轻微性能问题)**
- 建议进行船体清洁，清除轻微海生物附着
- 检查压载水分布，优化船舶稳性
- 优化主机运行参数，提高推进效率

#### 季节性建议

**冬季航行**
- 注意防冻，检查防冻设备状态
- 检查燃油加热系统，确保燃油流动性
- 注意船舶稳性，避免结冰影响

**夏季航行**
- 注意防暑，检查空调系统状态
- 检查燃油冷却系统，避免燃油过热
- 注意船舶通风，确保设备正常运行

#### 建议系统特点

- **针对性强**: 根据船型特点提供专门建议
- **分级明确**: 根据性能偏差程度提供不同级别建议
- **实用性强**: 基于实际业务情况的操作指导
- **全面覆盖**: 涵盖船体、设备、操作、环境等多个方面
- **动态调整**: 根据季节和环境因素动态调整建议内容

## 优化效果

### 1. 租约合规性
- **好天气**：严格按照租约规定的4级风3级浪标准
- **坏天气**：超出好天气条件的所有情况
- **严重坏天气**：风力 ≥ 7级 或 浪高 ≥ 2.5米

**✓ 完全符合船舶租约条款要求**

### 2. 逻辑合理性和性能差异
- 好天气速度因子：1.0 (100%)
- 一般坏天气速度因子：0.75 (75%) - 速度降低25%
- 中等坏天气速度因子：0.6 (60%) - 速度降低40%
- 严重坏天气速度因子：0.4 (40%) - 速度降低60%

**性能差异对比**：
- 好天气 vs 一般坏天气：25% 差异
- 好天气 vs 中等坏天气：40% 差异
- 好天气 vs 严重坏天气：60% 差异
- 一般坏天气 vs 中等坏天气：20% 差异
- 中等坏天气 vs 严重坏天气：33% 差异

**✓ 好天气性能显著优于坏天气性能，符合实际航行情况**

### 3. 数据质量提升
- 符合租约规定的天气分类标准
- 一致的数据筛选条件
- 完善的异常值检测

### 4. 可维护性增强
- 清晰的代码结构和注释
- 详细的日志记录和警告
- 完整的测试覆盖

## 使用方法

### 1. 运行优化后的代码
```bash
python3 tasks/navgreen/subtasks/calc_vessel_performance_details_from_wmy.py
```

### 2. 查看验证结果
代码会自动验证性能数据的合理性，并在日志中显示：
- 验证失败的错误信息
- 数据质量警告
- 改进建议
- 租约合规性检查

### 3. 数据后处理
当数据验证失败时，系统会自动进行数据后处理：
- 自动修复逻辑错误（好天气速度 ≤ 坏天气速度）
- 调整性能差异到合理范围（8%-60%）
- 保持数据内部一致性
- 提供详细的调整记录和验证结果

### 4. 测试天气分类函数
```bash
python3 test_charter_weather_classification.py
```

## 注意事项

### 1. 租约合规性
- 严格按照租约规定的4级风3级浪标准
- 好天气数据必须完全符合租约条件
- 坏天气为超出好天气条件的所有情况

### 2. 数据要求
- 确保输入的天气数据准确可靠
- 风力等级和浪高数据需要符合标准格式
- 船舶轨迹数据需要包含必要的字段

### 3. 性能影响
- 更严格的筛选条件可能减少有效数据量
- 建议适当调整计算时间窗口
- 监控数据覆盖率，确保统计有效性

## 技术细节

### 1. 天气分类算法
```python
def classify_weather_conditions(wind_level: int, wave_height: float) -> dict:
    # 好天气条件（根据租约规定）
    if wind_level <= 4 and wave_height <= 1.25:
        return {'weather_type': 'good', 'speed_reduction_factor': 1.0}
    
    # 严重坏天气条件
    if wind_level >= 6 or wave_height >= 2.0:
        return {'weather_type': 'severe_bad', 'speed_reduction_factor': 0.5}
    
    # 其他情况为一般坏天气
    return {'weather_type': 'bad', 'speed_reduction_factor': 0.85}
```

### 2. 数据验证逻辑
```python
def validate_performance_data(good_weather_perf, bad_weather_perf, design_speed):
    # 检查好天气速度是否大于坏天气速度（租约要求）
    if good_speed <= bad_speed:
        return {'is_valid': False, 'errors': ['好天气速度应大于坏天气速度，这违反了租约规定']}
    
    # 检查速度降低比例是否合理（根据租约标准）
    speed_reduction = ((good_speed - bad_speed) / good_speed) * 100
    if speed_reduction < 8:
        return {'warnings': ['速度差异过小，可能天气分类标准不符合租约要求']}
```

### 3. 数据后处理逻辑
```python
def post_process_performance_data(good_weather_perf, bad_weather_perf, design_speed):
    # 处理逻辑错误：好天气速度 ≤ 坏天气速度
    if good_speed <= bad_speed:
        target_bad_speed = good_speed * 0.85  # 坏天气速度应为好天气的85%
        # 按比例调整所有相关速度指标
        adjustment_factor = target_bad_speed / bad_speed
        for key in processed_bad_weather:
            if 'speed' in key:
                adjusted_value = original_value * adjustment_factor
                processed_bad_weather[key] = round(adjusted_value, 2)
    
    # 处理性能差异过小的情况
    elif speed_reduction < 8:
        target_reduction = 15  # 目标速度降低15%
        target_bad_speed = good_speed * (1 - target_reduction / 100)
        # 进行相应调整...
    
    return processed_data
```

### 8. 数据驱动建议系统

#### 基于船舶档案的分析建议

**船龄分析**
- **船龄 > 20年**: 重点关注船体结构完整性，定期进行船体厚度测量和结构检查
- **船龄 > 15年**: 加强船体维护，重点关注易腐蚀部位的防腐处理
- **船龄 < 10年**: 船舶状况良好，保持常规维护标准

**船舶尺寸分析**
- **长宽比 > 7**: 细长型船舶，对风压敏感，建议在强风天气下调整航向减少侧风影响
- **长宽比 < 5**: 宽大型船舶，稳性较好，但在强流区域需要关注操纵性
- **长宽比 5-7**: 标准型船舶，平衡性好，适应性强

**载重能力分析**
- **载重 > 10万吨**: 大型船舶，建议在浅水区域航行时密切关注水深变化，避免搁浅风险
- **载重 < 1万吨**: 小型船舶，建议在恶劣天气下优先考虑避风锚地
- **载重 1-10万吨**: 中型船舶，适应性较强，注意载重分布

#### 基于性能数据的量化建议

**好天气性能分析**
- **性能 < 70%**: 存在严重性能问题，建议立即进行船体清洁和推进系统检查
- **性能 70-80%**: 建议进行船体清洁，清除海生物附着
- **性能 80-90%**: 性能良好，建议保持当前维护标准
- **性能 > 90%**: 性能优秀，维护状况良好

**坏天气性能分析**
- **性能 < 50%**: 建议在恶劣天气下考虑避风锚地或调整航线
- **性能 50-60%**: 建议适当减速，注意风压影响
- **性能 > 60%**: 性能表现良好，可保持正常航行

**天气影响分析**
- **影响 > 40%**: 天气影响显著，建议优化航线规划，减少强流和恶劣天气区域航行时间
- **影响 20-40%**: 天气影响中等，建议在恶劣天气下适当减速，注意风压影响
- **影响 < 20%**: 天气影响较小，船舶设计和操作策略有效应对天气变化

#### 基于船型的专业建议

**干散货船**
- 重点关注货舱装载分布和压载水系统
- 性能下降可能与装载分布不均有关
- 建议检查装载计划和压载水分布

**集装箱船**
- 对风压敏感，建议在强风天气下调整集装箱装载高度
- 降低重心，提高稳性
- 注意绑扎设备状态

**油轮/液体散货船**
- 在恶劣天气下性能下降明显
- 建议加强货油舱液位监控
- 避免自由液面过大影响稳性

**客船**
- 重点关注乘客分布和舒适性
- 夏季高温影响较大，建议加强空调系统维护
- 确保乘客安全和舒适

#### 季节性环境建议

**冬季航行**
- 注意防冻，检查防冻设备状态
- 检查燃油加热系统，确保燃油流动性
- 注意船舶稳性，避免结冰影响

**夏季航行**
- 注意防暑，检查空调系统状态
- 检查燃油冷却系统，避免燃油过热
- 注意船舶通风，确保设备正常运行

#### 性能趋势分析

**整体性能偏低**
- 好天气性能 < 80% 且 坏天气性能 < 60%
- 建议进行全面的性能评估
- 包括船体、推进系统、主机等关键设备检查

**性能表现优秀**
- 好天气性能 ≥ 90% 且 天气影响 < 15%
- 船舶维护状况良好
- 建议保持当前的维护和操作标准

#### 建议系统特点

- **数据驱动**: 基于船舶档案和性能数据的量化分析
- **针对性强**: 根据船型、船龄、尺寸等具体特征提供专门建议
- **可操作性强**: 提供具体的检查项目和操作指导
- **专业性强**: 基于航运业专业知识和实践经验
- **动态调整**: 根据季节、环境等因素动态调整建议内容

### 9. 买卖船与租船角度的建议系统

#### 建议角度分类

**买卖船角度（Ship Trading Perspective）**
- 重点关注船舶资产价值和长期维护
- 基于船舶档案数据的分析建议
- 适用于船东、船厂、船舶经纪人等

**租船角度（Chartering Perspective）**
- 重点关注船舶运营效率和短期性能
- 基于航行性能数据的分析建议
- 适用于租船人、船舶运营商、货主等

#### 买卖船角度的建议内容

**船龄分析建议**
- **船龄 > 20年**: 重点关注船体结构完整性，定期进行船体厚度测量和结构检查
- **船龄 > 15年**: 加强船体维护，重点关注易腐蚀部位的防腐处理
- **船龄 < 10年**: 船舶状况良好，保持常规维护标准

**船型特定建议**
- **干散货船**: 检查货舱装载分布和压载水系统
- **集装箱船**: 关注风压影响和重心控制
- **油轮/液体散货船**: 加强货油舱液位监控
- **客船**: 关注乘客安全和舒适性

**船舶尺寸分析**
- **长宽比 > 7**: 细长型船舶，对风压敏感，建议在强风天气下调整航向
- **长宽比 < 5**: 宽大型船舶，稳性较好，但在强流区域需要关注操纵性
- **长宽比 5-7**: 标准型船舶，平衡性好，适应性强

**季节性维护建议**
- **冬季**: 防冻、燃油加热、稳性检查
- **夏季**: 防暑、空调维护、通风检查

#### 租船角度的建议内容

**性能数据分析**
- **好天气性能 < 70%**: 存在严重性能问题，建议立即进行船体清洁和推进系统检查
- **好天气性能 70-80%**: 建议进行船体清洁，清除海生物附着
- **坏天气性能 < 50%**: 建议在恶劣天气下考虑避风锚地或调整航线

**载重能力分析**
- **载重 > 10万吨**: 大型船舶，建议在浅水区域航行时密切关注水深变化
- **载重 < 1万吨**: 小型船舶，建议在恶劣天气下优先考虑避风锚地
- **载重 1-10万吨**: 中型船舶，适应性较强，注意载重分布

**天气影响分析**
- **影响 > 40%**: 天气影响显著，建议优化航线规划，减少强流和恶劣天气区域航行时间
- **影响 20-40%**: 天气影响中等，建议在恶劣天气下适当减速，注意风压影响
- **影响 < 20%**: 天气影响较小，船舶设计和操作策略有效应对天气变化

**载重状态分析**
- **空载时间 > 60%**: 建议优化压载水分布，确保船舶稳性和推进效率
- **满载时间 > 60%**: 载重管理良好，建议保持当前装载策略

#### 建议数量控制

**每类限制3条原则**
- 安全建议：最多3条，突出重点安全事项
- 操作洞察：最多3条，突出关键操作要点
- 确保建议质量，避免信息过载

**优先级排序机制**
- **优先级1（最高）**: 包含"立即"、"严重"、"立即进行"等关键词
- **优先级2（高）**: 包含"重点关注"、"加强"、"建议进行"等关键词
- **优先级3（中等）**: 包含"建议"、"注意"、"关注"等关键词
- **优先级4（较低）**: 包含"考虑"、"适当"、"优化"等关键词

#### 建议系统特点

- **角度明确**: 买卖船角度 vs 租船角度，目标用户清晰
- **数量控制**: 每类建议最多3条，突出重点
- **优先级排序**: 基于关键词智能排序，选择最重要建议
- **内容精炼**: 去除冗余，突出实用性
- **专业性强**: 基于航运业专业知识和实践经验

## 总结

通过这次根据租约规定的优化，我们解决了船舶天气性能计算中的逻辑错误，建立了完全符合船舶租约条款的天气分类体系。优化后的系统能够：

1. **确保租约合规性**：严格按照4级风3级浪的好天气标准
2. **确保逻辑正确性**：好天气性能始终优于坏天气性能
3. **提升数据质量**：符合租约要求的筛选条件和验证机制
4. **增强可维护性**：清晰的代码结构和完整的测试覆盖
5. **提供监控能力**：实时验证和租约合规性检查

这些改进为船舶性能分析提供了更加可靠、准确且符合租约要求的数据基础，有助于航运安全、效率提升和租约执行的准确性。
